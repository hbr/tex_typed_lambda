\section{Typing}




\subsection{Typing Relation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{definition}
The ternary \emph{typing relation} $\Gamma \vdash t: T$ which says that in
the context $\Gamma$ then term $t$ has type $T$ is defined inductively by
the rules
\begin{enumerate}
    \item Introduction rules:
    \begin{enumerate}
        \item Axiom:
            $$
            [] \vdash \Prop : \Any
            $$

        \item Variable:
            $$
            \rulev {
                \Gamma \vdash A: s
                \\
                x \notin \Gamma
            }
            {
                \Gamma, x^A \vdash x: A
            }
            $$

        \item Product:
            $$
            \rulev {
                \Gamma \vdash A: s_1
                \\
                \Gamma, x^A \vdash B: s_2
            }
            {
                \Gamma \vdash \Pi x^A.B : s_2
            }
            $$

        \item Abstraction:
            $$
            \rulev {
                \Gamma \vdash \Pi x^A. B: s
                \\
                \Gamma, x^A \vdash e: B
            }
            {
                \Gamma \vdash (\lambda x^A. e): \Pi x^A. B
            }
            $$

        \item Application:
            $$
            \rulev {
                \Gamma \vdash f: \Pi x^A. B
                \\
                \Gamma \vdash a: A
            }
            {
                \Gamma \vdash f a: B[x:=a]
            }
            $$
    \end{enumerate}


    \item Structural rules:
        \begin{enumerate}
            \item Weaken:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash A: s
                    \\
                    x \notin \Gamma
                }
                {
                    \Gamma, x^A \vdash t: T
                }
                $$

            \item Type equivalence:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash U: s
                    \\
                    T \betaeq U
                }
                {
                    \Gamma \vdash t: U
                }
                $$

        \end{enumerate}
    \end{enumerate}
\end{definition}



\subsection{Basic Definitions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{definition}
    \label{BasicTypingDefinitions} Basic Definitions:

    \begin{enumerate}
    \item $\Gamma \vdash t : T : U$ is defined as $\Gamma \vdash t : T$ and
        $\Gamma \vdash T : U$.

    \item $\Gamma \vdash \Delta$ for the contexts $\Gamma$ and $\Delta$ is
        defined as $\forall x^A \in \Delta \imp \Gamma \vdash x : A$.

    \item $\Gamma$ is a \emph{valid context} if $\Gamma \vdash t : T$ is valid
        for some terms $t$ and $T$.

    \item A term $t$ is welltyped in a context $\Gamma$ if $\Gamma \vdash t : T$
        is valid for some term $T$.

    \item A term $t$ is welltyped if there is a context in which it is
        welltyped.

    \item A term is valid in a context if it is either welltyped in the context
        or it is $\Any$.

    \item A term is valid if there is a context in which it is valid.

    \item A term $T$ is a valid type of sort $s$ in a context $\Gamma$ if
        $\Gamma \vdash T : s$ is valid.

    \item A term is a valid type of some sort if it is a valid type of this sort
        in some context.

    \item A term is a proposition or a proper type if it is a valid type of sort
        $\Prop$.

    \item A term is a kind if it is a valid type of sort $\Any$.
    \end{enumerate}
\end{definition}


\subsection{Start Lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{theorem}
    \label{StartLemma}
    For any valid context $\Gamma$ the following two typing judgements are
    valid:
    $$
    \begin{array}{l}
        \Gamma \vdash \Prop: \Any
        \\
        x^A \in \Gamma \imp \Gamma \vdash x :A
    \end{array}
    $$

    \begin{proof}
        A context $\Gamma$ is valid by definition if $\Gamma \vdash t: T$ is
        valid for some terms $t$ and $T$. We prove
        $$
        \begin{array}{l}
            \Gamma \vdash \Prop : \Any
            \\
            \land
            \\
            \forall x^A \in \Gamma \imp \Gamma \vdash x: A
        \end{array}
        $$
        by induction on $\Gamma \vdash t : T$.

        For all rules except the axiom, the variable rule and the weakening rule
        the goal is an immediate consequence of the induction hypothesis for the
        same context.  The axiom, the variable and the weakening rule are
        treated separately.

        \begin{enumerate}
        \item Axiom $[] \vdash \Prop: \Any$: The first part is trivially valid.
            The second part is vacuously valid, because the empty context does
                not have any variables.

        \item Variable:
            $$
            \begin{array}{l|l}
                \Gamma \vdash B: s
                &
                \Gamma \vdash \Prop : \Any
                \land
                (\forall x^A \in \Gamma \imp \Gamma \vdash x : A)
                \\
                y \notin \Gamma
                \\
                \hline
                \Gamma, y^B \vdash y: B
                &
                \Gamma, x^B \vdash \Prop:\Any
                \land
                (\forall x^A \in (\Gamma, x^B) \imp \Gamma, y^B \vdash x : A)
            \end{array}
            $$

            The first part of the goal in the lower right corner is a
                consequence of the induction hypothesis and the weaking rule.

            For the second part we have to distinguish two cases:
            \begin{itemize}
            \item $x^A \in \Gamma$: In that case the second part of the goal is
                a consequence of the second part of the induction hypothesis and
                    the weakening rule.
            \item $x^A = y^B$: In that case the second part of the goal is
                identical with the lower left corner.
            \end{itemize}

        \item Weakening:
            $$
            \begin{array}{l|l}
                \Gamma \vdash t : T
                \\
                \Gamma \vdash B: s
                &
                \Gamma \vdash \Prop : \Any
                \land
                (\forall x^A \in \Gamma \imp \Gamma \vdash x : A)
                \\
                y \notin \Gamma
                \\
                \hline
                \Gamma, y^B \vdash t: B
                &
                \Gamma, x^B \vdash \Prop:\Any
                \land
                (\forall x^A \in (\Gamma, x^B) \imp \Gamma, y^B \vdash x : A)
            \end{array}
            $$

            The reasoning is nearly the same as with the variable case. Except
            the second part of the goal for $x^A = y^B$ is proved by the
            variable introduction rule by using $\Gamma \vdash B : s$ and $y
            \notin \Gamma$.
        \end{enumerate}
    \end{proof}
\end{theorem}



\subsection{Thinning Lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{theorem}
    \label{ThinningLemma}
    \emph{Thinning Lemma}: Let $\Delta$ be a valid context with $\Gamma
    \subseteq \Delta$. Then
    $$
    \rulev{
        \Gamma \vdash t : T
    }
    {
        \Delta \vdash t : T
    }
    $$
    \begin{proof}
        By induction on $\Gamma \vdash t : T$.

        \begin{enumerate}
        \item Sort:
            $$ [] \vdash \Prop : \Any$$

            Since $\Delta$ is a valid context we get $\Delta \vdash \Prop :
                \Any$ by the start lemma~\ref{StartLemma}.

        \item Variable:
            $$
            \begin{array}{l|l}
            \Gamma \vdash A : s
            \\
            x \notin \Gamma
            \\
            \hline
            \Gamma, x^A \vdash x : A
            &
            \forall \Delta
                . \left[\rulev{
                    \Delta \text{ valid}
                    \\
                    \Gamma,x^A \subseteq \Delta
                }{
                    \Delta \vdash x: A
                }\right]
            \end{array}
            $$

            In order to prove the goal in the lower right corner we assume a
                valid context $\Delta$ which is a superset of $\Gamma,x^A$.
                Because of that it has en entry $x^A$. By the start
                lemma~\ref{StartLemma} we infer the goal.

        \item Product:
            $$
            \begin{array}{l|l}
            \Gamma \vdash A : s_1
            &
            \forall \Delta
                . \left[\rulev{
                    \Delta \text{ valid}
                    \\
                    \Gamma \subseteq \Delta
                }{
                    \Delta \vdash A: s_1
                }\right]
            \\
            \Gamma,x^A \vdash B: s_2
            &
            \forall \Delta'
                . \left[\rulev{
                    \Delta' \text{ valid}
                    \\
                    \Gamma,x^A \subseteq \Delta'
                }{
                    \Delta' \vdash B: s_2
                }\right]
            \\
            \hline
            \Gamma \vdash \Pi x^A. B: s_2
            &
            \forall \Delta
                . \left[\rulev{
                    \Delta \text{ valid}
                    \\
                    \Gamma \subseteq \Delta
                }{
                    \Delta \vdash \Pi x^A. B: s_2
                }\right]
            \end{array}
            $$


            In order to prove the goal in the lower right corner we assume a
            valid context $\Delta$ which is a superset of $\Gamma$ and derive
            the following facts:
            \begin{enumerate}
            \item $\Delta \vdash A: s_1$: This is an immediate consequence of
                the first induction hypothesis.

            \item $\Delta,x^A \vdash B : s_2$: We can assume $x \notin \Delta$.
                Otherwise we rename the variable such that the condition is
                    satisfied. The context $\Delta,x^A$ is a valid context
                    because of $\Delta\vdash A: s_1$ and the variable
                    introduction rule. By the second induction hypothesis we get
                    the subgoal.

            \item $\Delta\vdash \Pi x^A. B: s_2$: This fact can be derived from
                the previous two subgoals and the product introduction rule.
            \end{enumerate}
            The last fact proves the goal.

        \item Abstraction:

            Similar reasoning as in \emph{product}

        \item Application:

            $$
            \begin{array}{l|l}
                \Gamma \vdash f: \Pi x^A. B
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma \subseteq \Delta
                    }{
                        \Delta \vdash f: \Pi x^A. B
                    }\right]
                \\
                \Gamma \vdash a: A
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma \subseteq \Delta
                    }{
                        \Delta \vdash a: A
                    }\right]
                \\
                \hline
                \Gamma \vdash f a: B[x:=a]
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma \subseteq \Delta
                    }{
                        \Delta \vdash f a : B[x:=a]
                    }\right]
            \end{array}
            $$

            We assume a valid context $\Delta$ which is a superset of $\Gamma$.
            By the two induction hypotheses and the application introduction
            rule we infer the goal.

        \item Weaken:

            $$
            \begin{array}{l|l}
                \Gamma \vdash t : T
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma \subseteq \Delta
                    }{
                        \Delta \vdash t : T
                    }\right]
                \\
                \Gamma \vdash A : s
                \\
                x \notin \Gamma
                \\
                \hline
                \Gamma,x^A \vdash t : T
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma, x^A \subseteq \Delta
                    }{
                        \Delta \vdash t : T
                    }\right]
            \end{array}
            $$

            Let's assume a valid context $\Delta$ which is a superset of
            $\Gamma,x^A$. This implies that it is a superset of $\Gamma$ as
            well. The goal follows immediately from the first induction
            hypothesis.

        \item Type reduction:

            $$
            \begin{array}{l|l}
                \Gamma \vdash t : T
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma \subseteq \Delta
                    }{
                        \Delta \vdash t : T
                    }\right]
                \\
                \Gamma \vdash U : s
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma \subseteq \Delta
                    }{
                        \Delta \vdash U : s
                    }\right]
                \\
                T \betaeq U
                \\
                \hline
                \Gamma \vdash t : U
                &
                \forall \Delta
                    . \left[\rulev{
                        \Delta \text{ valid}
                        \\
                        \Gamma \subseteq \Delta
                    }{
                        \Delta \vdash t : U
                    }\right]
            \end{array}
            $$

            Let's assume a valid context $\Delta$ which is a superset of
            $\Gamma$. From the two induction hypotheses we get $\Delta \vdash t
            : T$ and $\Delta \vdash U : s$. We conclude the final goal by
            applying the type equivalence rule.
        \end{enumerate}
    \end{proof}
\end{theorem}






\subsection{Generation Lemmata}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{theorem}
    \label{GenerationLemmata}
    The following generation lemmata are valid:
    \begin{enumerate}
    \item Sort:
        $$
        \rulev{
            \Gamma \vdash s_1 : T
        }
        {
            s_1 = \Prop \land T \betaeq \Any
        }
        $$

    \item Variable:
        $$
        \rulev{
            \Gamma \vdash x : T
        }
        {
            \exists A,s .
            \left[
            \begin{array}{l}
                \Gamma \vdash A : s
                \\
                x^A \in \Gamma
                \\
                A \betaeq T
            \end{array}
            \right]
        }
        $$

    \item Product:
        $$
        \rulev{
            \Gamma \vdash \Pi x^A.B : T
        }
        {
            \exists s_1, s_2.
            \left[
            \begin{array}{l}
                \Gamma \vdash A: s_1
                \\
                \Gamma, x^A \vdash B: s_2
                \\
                s_2 \betaeq T
            \end{array}
            \right]
        }
        $$

    \item Abstraction:
        $$
        \rulev{
            \Gamma \vdash \lambda x^A. e : T
        }
        {
            \exists B, s.
            \left[
            \begin{array}{l}
                \Gamma \vdash \Pi x^A. B: s
                \\
                \Gamma, x^A \vdash e: B
                \\
                \Pi x^A. B  \betaeq T
            \end{array}
            \right]
        }
        $$

    \item Application:
        $$
        \rulev{
            \Gamma \vdash f a: T
        }
        {
            \exists A, B.
            \left[
            \begin{array}{l}
                \Gamma \vdash f : \Pi x^A. B
                \\
                \Gamma \vdash a : A
                \\
                B[x:=a]  \betaeq T
            \end{array}
            \right]
        }
        $$
    \end{enumerate}

    \begin{proof}
        The premise in all lemmata is the validity of $\Gamma \vdash t : T$
        where $t$ is either a sort, a variable, a product, an abstraction or an
        application. The goal in all lemmata is that some other terms exist and
        the type $T$ is beta equivalent (or identical) to some other type. All
        lemmata can be proved by induction on $\Gamma \vdash t : T$.

        \begin{enumerate}
        \item Introduction rules: For all generation lemmata only one
            introduction rule is syntactically possible. The corresponding
                introduction rule proves the goal trivially. As an example we
                prove the generation lemma for products.

                Only the introduction rule for products is syntactically
                possible.
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s_1
                    \\
                    \Gamma, x^A \vdash B: s_2
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A. B : s_2
                    &
                    \exists s_a, s_b.
                    \left[
                    \begin{array}{l}
                        \Gamma \vdash A : s_a
                        \\
                        \Gamma, x^A \vdash B : s_b
                        \\
                        s_2 \betaeq s_b
                    \end{array}
                    \right]
                \end{array}
                $$

                The goal in the lower right corner is proved by using $s_a =
                    s_1$ and $s_b = s_2$.

        \item Structural rules: For each of the generation lemmata and
            structural rule the prove is straightforward. Here we prove the
                generation lemma for products as an example.

            \begin{enumerate}
            \item Weaken:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A. B : T
                    &
                    \exists s_1, s_2.
                    \left[
                    \begin{array}{l}
                        \Gamma \vdash A : s_1
                        \\
                        \Gamma, x^A \vdash B : s_2
                        \\
                        T \betaeq s_2
                    \end{array}
                    \right]
                    \\
                    \Gamma \vdash C: s
                    \\
                    z \notin \Gamma
                    \\
                    \hline
                    \Gamma, z^C \vdash \Pi x^A. B: T
                    &
                    \exists s_a, s_b.
                    \left[
                    \begin{array}{l}
                        \Gamma, z^C \vdash A : s_a
                        \\
                        \Gamma, z^C, x^A \vdash B : s_b
                        \\
                        T \betaeq s_b
                    \end{array}
                    \right]
                \end{array}
                $$

                By the induction hypothesis there are some $s_1$ and $s_2$ which
                satisfy the conditions in the square brackets. In order to prove
                    the goal in the lower right corner and use $s_a = s_1$ and
                    $s_b = s_2$ and have to prove the following three subgoals:
                \begin{enumerate}
                \item $\Gamma, y^C \vdash A : s_1$: Since $\Gamma,y^C$ is a
                    valid context with $\Gamma \subseteq \Gamma,y^C$ we can
                        prove the subgoal by the thinning
                        lemma~\ref{ThinningLemma}.

                \item $\Gamma, z^C, x^A \vdash B : s_2 $: The previous subgoal
                    and the variable introduction rule ensures that
                        $\Gamma,y^C,x^A$ is a valid context with $\Gamma,x^A
                        \subseteq \Gamma,y^C,x^A$. By the thinning
                        lemma~\ref{ThinningLemma} and the induction hypothesis
                        we prove the current subgoal.

                \item $T \betaeq s_2$: This subgoal is identical to the third
                        proposition in the induction hypothesis.
                \end{enumerate}

            \item Type equivalence:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A. B : T
                    &
                    \exists s_1, s_2.
                    \left[
                    \begin{array}{l}
                        \Gamma \vdash A : s_1
                        \\
                        \Gamma, x^A \vdash B : s_2
                        \\
                        T \betaeq s_b
                    \end{array}
                    \right]
                    \\
                    \Gamma \vdash U : s
                    \\
                    T \betaeq U
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A. B : U
                    &
                    \exists s_a, s_b.
                    \left[
                    \begin{array}{l}
                        \Gamma \vdash A : s_a
                        \\
                        \Gamma, x^A \vdash B : s_b
                        \\
                        U \betaeq s_b
                    \end{array}
                    \right]
                \end{array}
                $$

                By the induction hypothesis there exist some $s_1$ and $s_2$
                which satisfy the propositions in the square brackets,
                especially $T \betaeq s_2$. To prove the goal in the lower right
                corner we use $s_a = s_1$ and $s_b = s_2$ and use the fact $T
                \betaeq U$ and the transitivity of beta equivalence.

            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}



\begin{corollary}
    \label{ContextWelltyped}
    \emph{All types in a valid context are welltyped}.

    \begin{proof}
        According to the start lemma~\ref{StartLemma} $\Gamma \vdash x : A$ is
        valid for each $x^A \in \Gamma$. By the generation
        lemma~\ref{GenerationLemmata} for variables there is a sort $s$ with
        $\Gamma \vdash A : s$. Therefore $A$ is welltyped.
    \end{proof}
\end{corollary}



\begin{corollary}
    \label{AnyNotWelltyped}
    \emph{The term $\Any$ is not welltyped}.

    \begin{proof}
        Let's assume it is welltyped. Then by definition there exists a context
        $\Gamma$ and a term $T$ such that $\Gamma \vdash \Any : T$ is valid. By
        the generation lemma~\ref{GenerationLemmata} for sorts we get $\Any =
        \Prop$ which is not possible.
    \end{proof}
\end{corollary}




\begin{corollary}
    \label{ContextHasNoAny}
    \emph{A valid context has no variable with the type $\Any$}.

    \begin{proof}
        By \ref{ContextWelltyped} all types in a context are welltyped and by
        \ref{AnyNotWelltyped} the term $\Any$ is not welltyped. Therefore $\Any$
        cannot be the type of a variable in a valid context.
    \end{proof}
\end{corollary}




\begin{corollary}
    \label{SubtermWelltyped}
    \emph{All subterms of a welltyped term are welltyped}.

    \begin{proof}
        We prove this corollary by proving that any direct subterm of a
        welltyped term is welltyped by induction on the structure of the
        welltyped term.

        For each possible form of a welltyped term the generation
        lemma~\ref{GenerationLemmata} for this form states the existence
        of a context and a type of each direct subterm, i.e. the direct subterms
        are welltyped.

        Repeating the argument proves that all indirect subterms of a welltyped
        subterm are welltyped as well.
    \end{proof}
\end{corollary}





\begin{corollary}
    \label{AnyNoSubterm}
    \emph{$\Any$ cannot be a subterm of a welltyped term}. This implies that
    terms like $\lambda x^\Any. e$, $\lambda x^A. \Any$, $\Pi x^\Any. B$ or $\Pi
    x^A. \Any$ cannot be welltyped, because they have $\Any$ as a subterm.

    \begin{proof}
        Assume that $\Any$ is a subterm of a welltyped term. Then by the
        corollary~\ref{SubtermWelltyped} $\Any$ must be welltyped. This
        contradicts corollary~\ref{AnyNotWelltyped}.
    \end{proof}
\end{corollary}



\subsection{Substitution Lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{theorem}
    \label{SubstitutionLemma}
    Substitution (cut) theorem.
    $$
    \rulev{
        \Gamma \vdash a: A
        \\
        \Gamma, x^A, \Delta \vdash t: T
    }
    {
        \Gamma, \Delta[x:=a] \vdash t[x:=a]: T[x:=a]
    }
    $$

    \begin{proof}
        We assume
        $\Gamma \vdash a: A$
        and prove this theorem by induction on
        $\Gamma, x^A, \Delta \vdash t: T$.

        In order to express the proof more compactly we introduce the
        abbreviation $t' := t[x:=a]$.

        \begin{enumerate}
            \item Axiom: This case is syntactically impossible, because the
                context is not empty.

            \item Variable: We have to prove the goal
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash B: s
                    &
                    \Gamma, \Delta' \vdash B': s
                    \\
                    \hline
                    \Gamma, x^A, \Delta, y^B \vdash y: B
                    &
                    \Gamma, \Delta', y^{B'} \vdash y: B'
                \end{array}
                $$

                The final goal in the lower right corner follows directly from
                the induction hypothesis and the variable introduction rule.

            \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash B: s_1
                    &
                    \Gamma, \Delta' \vdash B': s_1
                    \\
                    \Gamma, x^A, \Delta, y^B \vdash C: s_2
                    &
                    \Gamma, \Delta', y^{B'} \vdash C': s_2
                    \\
                    s_2 = \Prop \lor s_1 = s2
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash \Pi y^B. C : s_2
                    &
                    \Gamma, \Delta' \vdash \Pi y^{B'}. C': s_2
                \end{array}
                $$

                The final goal follows from the induction hypotheses and the
                product introduction rule.

            \item Abstraction:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash \Pi y^B. C: s
                    &
                    \Gamma, \Delta' \vdash \Pi y^{B'}. C': s
                    \\
                    \Gamma, x^A, \Delta, y^B \vdash e: C
                    &
                    \Gamma, \Delta', y^{B'} \vdash e': C'
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash \lambda y^B. e: \Pi y^B. C
                    &
                    \Gamma, \Delta' \vdash \lambda y^{B'}. e' : \Pi y^{B'}. C'
                \end{array}
                $$

                Same reasoning as above.

            \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash f: \Pi y^B. C
                    &
                    \Gamma, \Delta' \vdash f' : \Pi y^{B'}. C'
                    \\
                    \Gamma, x^A, \Delta \vdash b: B
                    &
                    \Gamma, \Delta' \vdash b': B'
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash f b: C[y:=b]
                    &
                    \Gamma, \Delta' \vdash f' b': (C[y:=b])'
                \end{array}
                $$

                From the induction hypotheses and the application introduction
                rule we conclude
                $$
                    \Gamma, \Delta' \vdash f' b': C'[y:=b']
                $$
                and get the final goal by observing
                $$
                    C'[y:=b'] = (C[y:=b])'
                $$
                by using the double substition lemma~\ref{DoubleSubstitution}.

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash t: T
                    &
                    \Gamma,\Delta' \vdash t' : T'
                    \\
                    \Gamma,x^A,\Delta \vdash B: s
                    &
                    \Gamma,\Delta' \vdash B' : s'
                    \\
                    \hline
                    \Gamma,x^A,\Delta,y^B \vdash t : T
                    &
                    \Gamma,\Delta',y^{B'} \vdash t' : T'
                \end{array}
                $$
                The goal in the lower right corner can be proved by the
                    induction hypotheses and the weakening rule.

                \item Type equivalence:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash t : T
                    &
                    \Gamma,\Delta' \vdash t' : T'
                    \\
                    \Gamma,x^A,\Delta \vdash U : s
                    &
                    \Gamma,\Delta' \vdash U' : s'
                    \\
                    T \betaeq U
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash t : U
                    &
                    \Gamma,\Delta' \vdash t' : U'
                \end{array}
                $$
                From the theorem~\ref{SubstituteEquivalence} we conclude that
                    $T'$ and $U'$ are beta equivalent.
                The goal in the lower right corner is an immediate consequence
                of the induction hypotheses and the type equivalence rule.
            \end{enumerate}

        \end{enumerate}
    \end{proof}
\end{theorem}




\subsection{Type of Types}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{theorem}
    \label{TypeOfTypes}
    \emph{A term in the type position of a context is either $\Any$ or it is a
    valid type of some sort}.

    $$
    \rulev{
        \Gamma \vdash t : T
    }
    {
        T = \Any \lor \exists s. \Gamma \vdash T : s
    }
    $$

    \begin{proof}
        By induction on $\Gamma \vdash t : T$:
        \begin{enumerate}
        \item Sort: Trivial

        \item Variable: Trivial by the premise of the variable introduction
            rule.

        \item Product: Easy, because there are only two sorts. If the sort is
            $\Prop$ then by the start lemma~\ref{StartLemma} $\Gamma\vdash
                \Prop: \Any$ is valid in any valid context. If the sort is
                $\Any$ then the goal is trivial.

        \item Abstraction:
            $$
            \begin{array}{l|l}
                \Gamma \vdash \Pi x^A. B : s_0
                \\
                \Gamma,x^A \vdash e: B
                \\
                \hline
                \Gamma \vdash \lambda x^A. e: \Pi x^A. B
                &
                \exists s. \Gamma \vdash \Pi x^A. B : s
            \end{array}
            $$

            Take $s = s_0$.

        \item Application:
            $$
            \begin{array}{l|l}
                \Gamma \vdash f: \Pi x^A. B
                & \exists s_0. \Gamma \vdash \Pi x^A. B: s_0
                \\
                \Gamma \vdash a: A
                \\
                \hline
                \Gamma \vdash f a: B[x:=a]
                &
                \exists s. \Gamma \vdash B[x:=a]: s
            \end{array}
            $$
            Remark: Since $\Any \ne \Pi x^A. B$ only the second alternative is
                interesting.

            From the induction hypothesis and the generation
                lemma~\ref{GenerationLemmata} for products we conclude the
                existence of a sort $s_2$ such that $\Gamma,x^A\vdash B: s_2$ is
                valid.

                By applying the substitution lemma~\ref{SubstitutionLemma} we
                get $\Gamma \vdash B[x:=a] : s_2$ which proves the goal.


        \item Weaken:
            The goal is easy to prove by the induction hypothesis and the
                weakening rule.

        \item Type Equivalence:

            The goal is a immediate consequence of one of the premises of the
                type equivalence rule.
        \end{enumerate}
    \end{proof}
\end{theorem}








\subsection{Subject Reduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{theorem}
    \label{SubjectReductionTheorem}
    \emph{Subject reduction lemma} Reduction of a term does change its type.
    $$
    \rulev{
        \Gamma \vdash t: T
        \\
        t \reduce u
    }
    {
        \Gamma \vdash u: T
    }
    $$

    {
    \def\SRLeftPart#1#2#3#4{
        \left(
        \forall #1.
        \ruleh{#2 \reduce #1}{#3 \vdash #1: #4}
        \right)
    }
    \def\SRRightPart#1#2#3#4{
        \left(
        \forall #1.
        \ruleh{#2 \reduce #1}{#1 \vdash #3: #4}
        \right)
    }

    \begin{proof} In order to prove the subject reduction lemma we prove the
        more general lemma
        $$
        \ruleh{
            \Gamma \vdash t: T
        }
        {
            \SRLeftPart u t \Gamma T
            \land
            \SRRightPart \Delta \Gamma t T
        }
        $$
        where $\Gamma \reduce \Delta$ means that $\Delta$ is $\Gamma$ with one
        of the variable types replaced by a reduced type.

        We prove the more general lemma by induction on $\Gamma \vdash t: T$.
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort: If $\Gamma$ is empty and $t$ is a sort, then the
                    goal is vacuously true because neither the empty context nor
                    a sort can reduce to anything (they are in normal form).

                \item Variable:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash A : s
                        &
                        \SRLeftPart B A \Gamma s
                        \land
                        \SRRightPart {\Delta_0} \Gamma A s
                        \\
                        \hline
                        \Gamma, x^A \vdash x: A
                        &
                        \SRLeftPart u x {\Gamma,x^A} A
                        \land
                        \SRRightPart \Delta {\Gamma,x^A} x A
                    \end{array}
                    $$
                    The left part of the goal in the lower right corner is
                    vacously true because a variable is in normal form and there
                    is no term to which it reduces.

                    For the right part we assume $\Gamma,x^A \reduce \Delta$.
                    There are two possibilities:
                    \begin{enumerate}
                        \item $\Delta = \Delta_0,x^A$ where $\Gamma \reduce
                            \Delta_0$ for some $\Delta_0$:

                        In that case we get $\Delta_0 \vdash A: s$ from the
                            induction hypothesis which implies the goal
                            $\Delta_0,x^A \vdash x: A$.

                        \item $\Delta = \Gamma,x^B$ where $A \reduce B$:

                        In that case we get $\Gamma \vdash B : s$ from the
                            induction hypothesis which implies the goal
                            $\Gamma,x^B: x \vdash B$.
                    \end{enumerate}

                \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s_1
                    &
                    \SRLeftPart C A \Gamma {s_1}
                    \lor
                    \SRRightPart \Delta \Gamma A {s_1}
                    \\
                    \Gamma,x^A \vdash B: s_2
                    &
                    \SRLeftPart D B {\Gamma,x^A} {s_2}
                    \lor
                    \SRRightPart {\Delta'} {\Gamma,x^A} B {s_2}
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A. B : s_2
                    &
                    \SRLeftPart t {\Pi x^A.B} \Gamma {s_2}
                    \land
                    \SRRightPart \Delta \Gamma {\Pi x^A. B} {s_2}
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: We assume $\Pi x^A. B \reduce t$.

                    Since products are preserved under reduction
                        (lemma~\ref{ReductionProductAbstraction}) we have either
                        $t = \Pi x^C. B$ where $A \reduce C$ for some $C$ or $t
                        = \Pi x^A.D$ where $B \reduce D$ for some $D$.

                    In both cases we can derive from the induction hypotheses
                        either $\Gamma \vdash C: s_1$ or $\Gamma,x^A \vdash D:
                        s_2$. Therefore $\Gamma \vdash \Pi x^C. B: s_2$ or $\Gamma
                        \vdash \Pi x^A.D: s_2$ is valid trivially.

                    \item Right part: Assume $\Gamma \reduce \Delta$. From the
                        first induction hypothesis we get $\Delta \vdash A:
                        s_1$. From the second induction hypothesis we get
                        $\Delta, x^A \vdash B: s_2$ where we use $\Delta' =
                        \Delta, x^A$. These facts imply $\Delta
                        \vdash \Pi x^A. B : s_2$.
                \end{enumerate}

                \item Abstraction: Same reasoning as with product.

                \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash f: \Pi x^A. B
                    &
                    \SRLeftPart g f \Gamma {\Pi x^A. B}
                    \land
                    \SRRightPart \Delta \Gamma f {\Pi x^A.B}
                    \\
                    \Gamma \vdash a: A
                    &
                    \SRLeftPart b a \Gamma A
                    \land
                    \SRRightPart \Delta \Gamma a A
                    \\
                    \hline
                    \Gamma \vdash f a: B[x:=a]
                    &
                    \SRLeftPart t {f a} \Gamma {B[x:=a]}
                    \land
                    \SRRightPart \Delta \Gamma {f a} {B[x:=a]}
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: Assume $f a \reduce t$. We have three cases
                        to consider.
                    \begin{enumerate}
                        \item $f a \reduce g a$ where $f \reduce g$:

                            From the first induction hypothesis we get that $g$
                            has the same type as $f$ and therefore $g a:
                            B[x:=a]$ is valid.

                        \item $f a \reduce f b$ where $a \reduce b$:

                            From the second induction hypothesis we get
                            $\Gamma \vdash b: A$ and therefore $\Gamma \vdash f
                            a : B[x:=b]$.

                            Since $B[x:=a]$ is a valid type and because of
                            lemma~\ref{SubstituteReduction} we have $B[x:=a]
                            \reduce B[x:=b]$ and therefore $B[x:=b] \le
                            B[x:=a]$. The subtype rule let us derive
                            $\Gamma \vdash f b: B[x:=a]$ which is identical to
                            the final goal.

                        \item $(\lambda x^A. e) a \reduce e[x:=a]$:

                            In that case we have to prove
                            $$
                                \rulev{
                                    \Gamma \vdash \lambda x^A. e: \Pi x^A.B
                                    \\
                                    \Gamma \vdash a: A
                                }
                                {
                                    \Gamma \vdash e[x:=a]: B[x:=a]
                                }
                            $$

                            We assume $\Gamma \vdash \lambda x^A. e: \Pi x^A.B$
                            and $\Gamma \vdash a : A$ and prove the final goal.

                            Since $\Pi x^A.B$ is not $\Any$ the type of types
                            lemma~\ref{TypeOfTypes} states the existence of a
                            sort $s$ such that $\Gamma \vdash \Pi x^A. B : s$ is
                            valid and then by the generation
                            lemma~\ref{GenerationLemmata} for products we get
                            the existence of some $s_B$ such that $\Gamma, x^A
                            \vdash B: s_B$ is valid which implies by the
                            substitution lemma~\ref{SubstitutionLemma} $\Gamma
                            \vdash B[x:=a]: s_B$.

                            According to the generation
                            lemma~\ref{GenerationLemmata} for abstractions there
                            are some $B_0$ and $s_0$ with
                            $$
                            \begin{array}{l}
                                \Gamma \vdash \Pi x^A. B_0 : s_0
                                \\
                                \Gamma,x^A \vdash e: B_0
                                \\
                                \Pi x^A.  B_0 \betaeq \Pi x^A.B
                            \end{array}
                            $$
                            The second one together with $\Gamma\vdash a:A$ and
                            the substitution lemma~\ref{SubstitutionLemma} gives
                            us $\Gamma \vdash e[x:=a] : B_0[x:=a]$.

                            The third one with the Church Rosser
                            theorem~\ref{BetaEquivalentCommonReduct} give $B \betaeq B_0$
                            which by the theorem~\ref{SubstituteEquivalence}
                            results in $B[x:=a] \betaeq B_0[x:=a]$.

                            Finally we can convert $\Gamma \vdash e[x:=a] :
                            B_0[x:=a]$, $\Gamma \vdash B[x:=a]: s_B$ and
                            $B[x:=a] \betaeq B_0[x:=a]$ via the type equivalence
                            rule into the final goal.
                    \end{enumerate}

                    \item Right part: Immediate consequence of the induction
                        hypotheses.
                \end{enumerate}
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weaken:
                $$
                \begin{array}{l|l}
                \Gamma \vdash t : T
                &
                \SRLeftPart u t \Gamma T
                \land
                \SRRightPart {\Delta_0} \Gamma t T
                \\
                \Gamma \vdash A : s
                &
                \SRLeftPart B A \Gamma s
                \land
                \SRRightPart {\Delta_0} \Gamma A s
                \\
                x \notin \Gamma
                \\
                \hline
                \Gamma, x^A \vdash t : T
                &
                \SRLeftPart u t {\Gamma, x^A} T
                \land
                \SRRightPart \Delta {\Gamma,x^A} t T
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: Assume $t \reduce u$. From the first
                        induction hypothesis we get $\Gamma \vdash u : T$ which
                        derives the final goal by applying the variable
                        introduction rule.

                    \item Right part:
                        We assume $\Gamma,x^A \reduce \Delta$ and have to
                        distinguish two cases.
                        \begin{enumerate}
                        \item
                            $\Delta = (\Delta_0, x^A)
                            \land \Gamma \reduce \Delta_0$:

                            In that case we get $\Delta_0 \vdash t : T$ and
                                $\Delta_0 \vdash A : s$ from the induction
                                hypotheses which imply the final goal $\Delta_0,
                                x^A \vdash t : T$ by application of the
                                weakening rule.

                        \item
                            $\Delta = (\Gamma, x^B)
                            \land A \reduce B$:

                            In that case we get $\Gamma \vdash B : s$ from the
                                second induction hypothesis which implies the
                                final goal $\Gamma, x^B \vdash t : T$ by
                                application of the weakening rule.
                    \end{enumerate}
                \end{enumerate}


                \item Type equivalence:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    &
                    \SRLeftPart u t \Gamma T
                    \land
                    \SRRightPart \Delta \Gamma t T
                    \\
                    \Gamma \vdash U : s
                    &
                    \ldots
                    \land
                    \SRRightPart \Delta \Gamma U s
                    \\
                    T \betaeq U
                    \\
                    \hline
                    \Gamma \vdash t : U
                    &
                    \SRLeftPart u t \Gamma U
                    \land
                    \SRRightPart \Delta \Gamma t U
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: Assume $t \reduce u$. We get $\Gamma \vdash
                        u: T$ by the first induction hypothesis. The final goal
                        $\Gamma \vdash u: U$ is obtained by applying the type
                        equivalence rule.

                    \item Right part: Assume $\Gamma \reduce \Delta$. From the
                        first induction hypothesis we derive $\Delta \vdash t :
                        T$ and from the second induction hypothesis we derive
                        $\Delta \vdash U : s$. The final goal $\Delta \vdash t:
                        U$ is obtained by applying the type equivalence rule.
                \end{enumerate}
            \end{enumerate}
        \end{enumerate}
    \end{proof}
    }
\end{theorem}





\subsection{Type Uniqueness}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{theorem}
    \label{TypeUniqueness1}
    \emph{All types of a term are beta equivalent}
    $$
    \rulev{
        \Gamma \vdash t : T
        \\
        \Gamma \vdash t : U
    }
    {
        T \betaeq U
    }
    $$

    \begin{proof}
        By induction on the structure of $t$ using the generation
        lemmata~\ref{GenerationLemmata}. The generation lemma for each form of
        $t$ guarantees the existence of a term $V$ for which $V \betaeq T$ and
        $V \betaeq U$ is valid. By transitivity of beta equivalence $T \betaeq
        U$ is implied.
    \end{proof}
\end{theorem}



\begin{theorem}
    \label{TypeUniqueness2}
    \emph{All types of beta equivalent terms are beta equivalent}
    $$
    \rulev{
        t \betaeq u
        \\
        \Gamma \vdash t : T
        \\
        \Gamma \vdash u : U
    }
    {
        T \betaeq U
    }
    $$

    \begin{proof}
        $ t \betaeq u$ implies by the Church Rosser
        Theorem~\ref{BetaEquivalentCommonReduct} the existence of a term $v$
        such that $t \reducestar v$ and $u \reducestar v$ are valid.

        By repeated application of the subject reduction theorem we get $\Gamma
        \vdash v : T$ and $\Gamma \vdash v : U$.

        This implies by the previous theorem~\ref{TypeUniqueness1} the validity
        of $T \betaeq U$.
    \end{proof}
\end{theorem}

