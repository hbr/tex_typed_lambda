\section{Confluence}

One of the most important features of beta reduction is \emph{confluence} which
states that the result of subsequent beta reductions is independent of the
sequence of redexes reduced. In order to state that property precisely we need
some definitions.

\begin{definition}
    \emph{Diamond Property} A relation $r$ has the diamond property if $a
    \torel{r} b$ and $a \torel{r} c$ implies the existence of some $d$ such that
    $b \torel{r} d$ and $c \torel{r} d$ are valid.

    $$
    \ruleh{
        a \torel r b
        \\
        a \torel r c
    }
    {
        \exists d. b \torel{r} d \land c \torel{r} d
    }
    $$
\end{definition}

We can state the diamond property of a relation $r$ more pictorially as
$$
\begin{array}{lll}
    a   &  \torel{r} &   b
    \\
    \downarrow_r & & \downarrow_r
    \\
    c & \torel{r} & \exists d
\end{array}
$$
which looks like a diamond if tilted by $45^\circ$ clockwise.


\begin{definition}
    \emph{Confluence} A relation $r$ is confluent if its reflexive transitive
    closure $r^*$ is a diamond.
\end{definition}


\begin{theorem}
    \label{ChurchRosser}
    \emph{Beta reduction is confluent}.

    \begin{proof}
    To prove this claim we use the following reasoning.

    \begin{enumerate}

        \item We prove the \emph{stripe lemma}~\ref{StripeLemma2} stating that
        the reflexive transitive closure of a diamond is a diamond i.e. that a
        diamond is confluent.

        \item We define a parallel beta reduction relation $\preduce$ which a
        superset of the beta reduction relation $\reduce$ i.e.  $(\reduce) \le
        (\preduce)$ (lemma~\ref{ReductionLeParallelReduction}) and a subset of
        the reflexive transitive closure of the beta reduction i.e. $(\preduce)
        \le (\reducestar)$ (lemma~\ref{ParallelReductionLeReductionStar}).

        \item We prove that the parallel beta reduction is a diamond
        (theorem~\ref{ParallelReductionDiamond}).

        \item We use the general facts that reflexive transitive closure is
        \begin{enumerate}
            \item monotonic $r \le s \imp r^* \le s^*$

            \item idempotent $(r^*)^* = r$
        \end{enumerate}
        to see that $(\reducestar) \le (\preducestar)$ and $(\preducestar) \le
        (\reducestar)$ are satisfied which imply by antisymmetry of the order
        relation that $(\reducestar) = (\preducestar)$.

        Since $\preducestar$ is a diamond, $\reducestar$ is a diamond as well.
        Therefore we can conclude the fact that beta reduction is confluent.
    \end{enumerate}
    \end{proof}
\end{theorem}





\subsection{Stripe Lemma}

In this section we prove the fact that the reflexive transitive closure of
diamond is a diamond. We need the following helper lemma:

\begin{lemma}
    \label{StripeLemma1}
    If $r$ is a diamond then
    $$
    \ruleh{
        a \torel{r^*} b
        \\
        a \torel r c
    }
    {
        \exists d. b \torel r d \land c \torel{r^*} d
    }
    $$
    is valid.

    \begin{proof}
        By induction on $a \torel{r^*} b$.

        \begin{enumerate}
        \item In the reflexive case we have $a = b$. We choose $d = c$ which
        satisfies the required properties.

        \item
        $$
        \begin{array}{l|l}
            a \torel{r^*} b
            &
            \forall d.
            \left[
            \ruleh{
                a \torel r d
            }
            {
                \exists e. b \torel r e \land d \torel{r^*} e
            }
            \right]
            \\
            b \torel r c
            \\
            \hline
            a \torel{r^*} c
            &
            \forall d.
            \left[
            \ruleh{
                a \torel r d
            }
            {
                \exists f. c \torel r f \land d \torel{r^*} f
            }
            \right]
        \end{array}
        $$
        To prove the goal in the lower right corner we assume $a \torel r d$ and
        try to find some $f$ with the required properties.

        From the induction hypothesis we find some $e$ which satisfies $b \torel
        r e$ and $d \torel{r^*} e$.

        Since $r$ is a diamond there exists some $f$ which satisfies $c \torel r
        f$ and $e \torel r f$. Since $d \torel{r^*} e$ we conclude $d
        \torel{r^*} f$ and have the desired properties for $f$.
        \end{enumerate}
    \end{proof}

\end{lemma}



\begin{lemma}
    \label{StripeLemma2}
    \emph{Stripe Lemma} If $r$ is a diamond, then $r^*$ is a diamond as well.
    $$
    \ruleh {
        a \torel{r^*} b
        \\
        a \torel{r^*} c
    }
    {
        \exists d. b \torel{r^*} d \land c \torel{r^*} d
    }
    $$

    \begin{proof}
        We assume $a \torel{r^*} b$ and do induction on $a \torel{r^*} c$

        \begin{enumerate}
        \item In the reflexive case we have $a = c$. We use $d = b$ which
        satisfies the required properties.

        \item
        $$
        \begin{array}{l|l}
            a \torel{r^*} c
            &
            \exists e. b \torel{r^*} e \land c \torel{r^*} e
            \\
            c \torel r d
            \\
            \hline
            a \torel{r^*} d
            &
            \exists f. b \torel{r^*} f \land d \torel{r^*} f
        \end{array}
        $$
        We have to prove the goal in the lower right corner i.e. find some $f$
        with the required properties.

        From the induction hypothesis we find some $e$ such that
        $$
        \begin{array}{lll}
            a &\torel{r^*}& b
            \\
            \downarrow_{r^*} & & \downarrow_{r^*}
            \\
            c &\torel{r^*}& e
        \end{array}
        $$
        is valid. From the previous lemma~\ref{StripeLemma1} we find some $f$
        such that
        $$
        \begin{array}{lll}
            c &\torel{r^*}& e
            \\
            \downarrow_{r} & & \downarrow_{r}
            \\
            d &\torel{r^*}& f
        \end{array}
        $$
        is valid. Therefore $f$ satisfies the required properties.
        \end{enumerate}
    \end{proof}
\end{lemma}








\subsection{Parallel Reduction Relation}


\subsubsection{Definition of the Parallel Reduction Relation}

\begin{definition}
    The \emph{parallel reduction relation} $a \preduce b$ is defined inductively
    by the rules
    \begin{enumerate}
    \item Reflexive
    $$
        a \preduce a
    $$

    \item Redex
    $$
        \rulev {
            a \preduce b
            \\
            e \preduce f
        }
        {
            (\lambda x^A. e) a \preduce f[x:=b]
        }
    $$

    \item Product
    $$
    \rulev {
        A \preduce C
        \\
        B \preduce D
    }
    {
        \Pi x^A. B \preduce \Pi x^C. D
    }
    $$

    \item Abstraction
    $$
    \rulev {
        A \preduce B
        \\
        e \preduce f
    }
    {
        \lambda x^A. e \preduce \lambda x^B. f
    }
    $$

    \item Application
    $$
    \rulev {
        a \preduce c
        \\
        b \preduce d
    }
    {
        a b \preduce c d
    }
    $$
    \end{enumerate}
\end{definition}


\begin{lemma}
    \label{ReductionLeParallelReduction}
    \emph{Parallel beta reduction is a superset of beta reduction}

    \begin{proof} This fact is trivial, because all rules of beta reduction are
    contained as special cases within the rules of parallel beta reduction.
    \end{proof}
\end{lemma}



\begin{lemma}
    \label{ParallelReductionLeReductionStar}
    \emph{Parallel beta reduction is a subset of the transitive closure of beta
    reduction}

    \begin{proof}
        All rules of parallel beta reduction are satisfied by the transitive
        closure of beta reduction. Since an inductive relation defined by some
        rules is the smallest relation which satisfies the rules, it is evident
        that parallel beta reduction must be smaller than the transitive closure
        of beta reduction.
    \end{proof}
\end{lemma}







\begin{lemma}
    \label{ParallelReductionSubstitution1}
    \emph{Basic compatibility of parallel reduction and substitution}
    $$
    \rulev{
        t \preduce u
    }
    {
        a[x:=t] \preduce a[x:=u]
    }
    $$

    \begin{proof}
    By induction on the structure of $a$.
    \begin{enumerate}
    \item $a$ is a sort: Trivial, because substitution does not change a sort
    and reflexivity of the parallel beta reduction.

    \item $a$ is a variable, let's say $y$: In the case $x=y$ the goal is
    implied by the premise. In the case $x \ne y$ the goal is implied by
    reflexivity.

    \item $a$ is the product $\Pi y^B. C$: We have to prove the goal
    $(\Pi y^B. C)[x:=t] \preduce (\Pi y^B.C)[x:=u]$ from the premise $t \preduce
    u$ and the induction hypotheses  $B[x:=t] \preduce B[x:=u]$ and
    $C[x:=t] \preduce C[x:=u]$. The validity of the goal can be seen from the
    following derivation.
    $$
    \begin{array}{lllll}
        (\Pi y^B. C)[x:=t]
        &=& \Pi y^{B[x:=t]}. C[x:=t]
        &\text{definition of substitution}
        \\
        &\preduce& \Pi y^{B[x:=u]}. C[x:=u]
        &\text {induction hypothesis}
        \\
        &=& (\Pi y^B. C)[x:=u]
        &\text{definition of substitution}
    \end{array}
    $$

    \item $a$ is the abstraction $\lambda y^B. e$: Same reasoning as with
    product.

    \item $a$ is the application $f a$: Same reasoning as with
    product.
    \end{enumerate}
    \end{proof}
\end{lemma}


\begin{lemma}
    \label{ParallelReductionSubstitution2}
    \emph{Full compatibility of parallel reduction and substitution}
    $$
    \rulev{
        a \preduce b
        \\
        t \preduce u
    }
    {
        a[x:=t] \preduce b[x:=u]
    }
    $$

    \begin{proof}
        By induction on $a \preduce b$.

        \begin{enumerate}
        \item Reflexive: In that case we have $a = b$. The goal is an immediate
        consequence of lemma~\ref{ParallelReductionSubstitution1}

        \item Redex:
        $$
        \begin{array}{l|l}
            a \preduce b
            & a[x:=t] \preduce b[x:=u]
            \\
            e \preduce f
            & e[x:=t] \preduce f[x:=u]
            \\
            \hline
            (\lambda y^A. e) a \preduce f[y:=b]
            &
            ((\lambda y^A. e) a)[x:=t] \preduce f[y:=b][x:=u]
        \end{array}
        $$

        The validity of the goal in the lower right corner can be seen from the
        following reasoning:
        $$
        \begin{array}{lllll}
            ((\lambda y^A. e) a)[x:=t]
            &=& (\lambda y^{A[x:=t]}. e[x:=t]) a[x:=t]
            &\text{definition of substition}
            \\
            &\preduce& f[x:=u][y:=b[x:=t]]
            &\text{induction hypotheses}
            \\
            &=& f[y:=b][x:=u] &\text{lemma~\ref{DoubleSubstitution}}
        \end{array}
        $$

        \item Product, abstraction and application: Some reasoning as with
        \emph{redex}. The lemma~\ref{DoubleSubstitution} is not needed in these
        cases.
        \end{enumerate}
    \end{proof}
\end{lemma}


\begin{lemma}
    \label{ParallelReductionProductAbstraction}
    \emph{The product and abstraction are preserved under parallel
    reduction}

    \begin{enumerate}
    \item
        $\ruleh{\lambda x^A. e \preduce c}
        {\exists B f. c = \lambda x^B. f
            \land A \preduce B \land e \preduce f}$

    \item
        $\ruleh{\Pi x^A. B \preduce c}
        {\exists C D. c = \Pi x^C. D
            \land A \preduce C \land B \preduce D}$
    \end{enumerate}

    \begin{proof} By induction on the premise. In both cases only one rule
    is syntactically possible which guarantees the existence of the
    corresponding terms.
    \end{proof}
\end{lemma}





\subsubsection{Parallel Reduction is a Diamond}


\begin{theorem}
    \label{ParallelReductionDiamond}
    \emph{Parallel reduction is a diamond}
    $$
    \ruleh{
        a \preduce b
    }
    {
        \forall c.
        \left[
        \ruleh{a \preduce c}{\exists d. b \preduce d \land c \preduce d}
        \right]
    }
    $$

    \begin{proof} By induction on $a \preduce b$.

        \begin{enumerate}
        \item Reflexive
        $$
        \begin{array}{l|l}
            a \preduce a
            &
            \forall c.
            \left[
                \ruleh{a \preduce c}{\exists d. c \preduce d \land a \preduce d}
            \right]
        \end{array}
        $$
        To prove the goal on the right side we assume $a \preduce c$. Then we use
        $c$ for $d$ which satisfies the required property of $d$ trivially.

        \item Redex
        $$
        \begin{array}{l|l}
            e \preduce f
            &
            \forall g.
            \left[
                \ruleh{e \preduce g}{\exists h. f \preduce h \land g \preduce h}
            \right]
            \\
            a \preduce b
            &
            \forall c.
            \left[
                \ruleh{b \preduce c}{\exists d. b \preduce d \land c \preduce d}
            \right]
            \\
            \hline
            (\lambda x^A. e) a \preduce f[x:=b]
            &
            \forall k.
            \left[
                \ruleh{
                    (\lambda x^A.e) a \preduce k
                }
                {
                    \exists n. k \preduce n \land f[x:=b] \preduce n
                }
            \right]
        \end{array}
        $$
        To prove the goal in the lower right corner we assume $(\lambda x^A.e)a
        \preduce k$ and do a case split on the construction of this relation.

            \begin{enumerate}
            \item Reflexive: In that case $k = (\lambda x^A. e) a$. We use $n =
            f[x:=b]$ which has the required property.


            \item Redex: In that case $k = g[x:=c]$ for some $g$ and $c$ with the
            properties $e \preduce g$ and $a \preduce c$.

            We have to find a term $n$ with $f[x:=b] \preduce n \land g[x:=c]
            \preduce n$. The term
            $$
                n = h[x:=d]
            $$
            with the terms $h$ and $d$ which exist by the induction hypotheses. It
            is easy to see that the properties
            $$
            \begin{array}{lll}
                f[x:=b] &\preduce& h[x:=d]
                \\
                g[x:=c] &\preduce& h[x:=d]
            \end{array}
            $$
            are satisfied because of the induction hypotheses and
            lemma~\ref{ParallelReductionSubstitution2}


            \item Product: This case is syntactically impossible because
            $(\lambda x^A.e) a$ cannot be a product.


            \item Abstraction: This case is syntactically impossible because
            $(\lambda x^A.e) a$ cannot be an abstraction.


            \item Application: In that case $k = (\lambda x^B. g) c$ for some
            $B$, $g$ and $c$ with $A \preduce B$, $e \preduce g$ and $a \preduce
            c$. Because of lemma~\ref{ParallelReductionProductAbstraction} we
            have chosen the more specific term $\lambda x^B. g$ instead of a
            more general term.

            We have to find a term $n$ which satisfies $(\lambda x^B. g) c
            \preduce n$ and $f[x:=b] \preduce n$.

            We use the term
            $$
                n = h[x:=d]
            $$
            with the terms $h$ and $d$ which exist by the induction hypotheses
            satisfying
            $$
            \begin{array}{lll}
                f &\preduce& h
                \\
                g &\preduce& h
                \\
                b &\preduce& d
                \\
                c &\preduce& d
            \end{array}
            $$
            Therefore the goals
            $$
            \begin{array}{lll}
                (\lambda x^B.g) c &\preduce& h[x:=d]
                \\
                f[x:=b] &\preduce& h[x:=d]
            \end{array}
            $$
            are satisfied
            \end{enumerate}


        \item Product
        $$
        \begin{array}{l|l}
            A \preduce C
            &
            \forall E.
            \left[
            \ruleh{A \preduce E}{\exists H. C \preduce H \land E \preduce H}
            \right]
            %
            \\
            B \preduce D
            &
            \forall F.
            \left[
            \ruleh{B \preduce F}{\exists J. D \preduce J \land F \preduce J}
            \right]
            %
            \\
            \hline
            \Pi x^A. B \preduce \Pi x^C. D
            &
            \forall E F.
            \left[
            \ruleh {
                \Pi x^A.B \preduce \Pi x^E. F
            }
            {
                \exists n.
                \Pi x^C. D \preduce n
                \land
                \Pi x^E. F \preduce n
            }
            \right]
        \end{array}
        $$
        In order to prove the goal in the lower right corner we assume $\Pi x^A.
        B \preduce \Pi x^E.F$.

        Because of lemma~\ref{ParallelReductionProductAbstraction} which says
        that parallel reduction preserves products we have chosen the more
        specific $\Pi x^E.F$ which satisfies $A \preduce E$ and $B \preduce F$
        instead of the more general $k$.

        From the induction hypotheses we conclude the existence of the terms $H$
        and $J$ such that
        $$
            n = \Pi x^H. J
        $$
        satisfies the required properties.

        \item Abstraction: Same reasoning as with product.

        \item Application
        $$
        \begin{array}{l|l}
            a \preduce c
            &
            \forall e.
            \left[
            \ruleh{
                a \preduce e
            }
            {
                \exists g. c \preduce g \land e \preduce g
            }
            \right]
            %
            \\
            b \preduce d
            &
            \forall f.
            \left[
            \ruleh{
                b \preduce f
            }
            {
                \exists h. d \preduce h \land f \preduce h
            }
            \right]
            %
            \\
            \hline
            a b \preduce c d
            &
            \forall k.
            \left[
            \ruleh{
                a b \preduce k
            }
            {
                \exists n. c d \preduce n \land k \preduce n
            }
            \right]
        \end{array}
        $$
        To prove the goal in the lower right corner we assume $a b \preduce k$
        and do a case split on the construction of this relation.

            \begin{enumerate}
            \item Reflexive: In that case $k = a b$. We use $n = c d$ which
            satisfies the required properties.

            \item Redex: In this case $a b$ has to be a redex, let's say
            $(\lambda x^A.m) b$. Therefore and because of
            lemma~\ref{ParallelReductionProductAbstraction} $a b \preduce c d$
            becomes $(\lambda x^A. m) b \preduce (\lambda x^B. o) d$ for some
            $B$ and $o$ with $A \preduce B$ and $m \preduce o$.

            $k$ has to be the reduct $p[x:=f]$ for some $p$, $f$ with $m
            \preduce p$ and $b \preduce f$.

            We have to find some term $n$ which satisfies
            $$
            \begin{array}{lll}
                (\lambda x^B. o) d &\preduce& n
                \\
                p[x:=f] &\preduce& n
            \end{array}
            $$

            From the first induction hypothesis and
            lemma~\ref{ParallelReductionProductAbstraction} we postulate the
            existence of $q$ with $o \preduce q$ and $p \preduce q$.

            From the second induction hypothesis we conclude the existence of
            some $h$ with with $d \preduce h$ and $f \preduce h$.

            Therefore the term
            $$
                n = q[x:=h]
            $$ satisfies the requirement.

            \item Product: This case is syntactically impossible because $a b$
            cannot be a product.

            \item Abstraction: This case is syntactically impossible because $a b$
            cannot be an abstraction.

            \item Application: In that case $k = e f$ for some terms $e$, $f$ which
            satisfy $a \preduce e$ and $b \preduce f$. We have to find some term
            $n$ which satisfies $c d \preduce n$ and $ e f \preduce n$.

            By the induction hypotheses there exist some terms $g$ and $h$
            satisfying $c \preduce g$, $e \preduce g$, $d \preduce h$ and $f
            \preduce h$ such that the term
            $$
                n = g h
            $$
            satisfies the requirement.
            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}
