\begin{comment}
    todo:

    - prove A <= B => t -> u => A[x:=t] <= B[x:=u]

    - prove all (x:A1): B1 <= all (x:A2): B2 => A1 ~ A2 and B1 <= B2

\end{comment}


\section{Cumulativity / Subtyping}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this section we want to define a subtype relation $A \le B$ (read $A$ is a
subtype of $B$) which is a partial order (reflexive, transitive and
antisymmetric) with respect to beta equivalent terms.

Furthermore we want a proper subtype relation $A < B$ (read $A$ is a proper
subtype of $B$) which is a strict partial order (irreflexive and transitive)
with respect to beta equivalence.

In the partial orders we regard beta equivalent terms as the same terms.

In order to define the partial orders we first define the prececessor relation
$A \prec_i B$ saying that type $A$ is a predecessor of type $B$ and both have
the arity $i$. In the predecessor relation we consider only terms of the form
$\Pi \vec{x}^\vec{A}. s$ where $s$ is a sort i.e. it has the form $\Any_k$ with
$-1 \le k$. Only terms with identical arguments and same arity figure in the
predecessor relation i.e. $\Pi \vec{x}^\vec{A}. \Any_k \prec_i \Pi
\vec{x}^\vec{A}. \Any_l$ if $k < l$ and $i$ is the number of arguments.

Based on this we define the proper subtype relation $A < B$ saying that $A$ is a
proper subtype of $B$ and both are beta equivalent to some terms $A'$ and $B'$
which figure in the predecessor relation for some arity $i$ and are beta
equivalent to $A$ and $B$ respectively.

Finally the subtype relation $A \le B$ is defined by stating that either $A$ is
beta equivalent to $B$ or $A$ is a proper subtype of $B$.



\subsection{Predecessor Relation}

\begin{definition}
    We define the
    %
    \emph{predecessor relation}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%
    %
    $A \prec_i B$ between the terms $A$
    and $B$ with the arity $i$ inductively by the following rules
    \begin{enumerate}
    \item
        $$
        \ruleh {
            -1 \le k < l
        }
        {
            \Any_k \prec_0 \Any_l
        }
        $$

    \item
        $$
        \ruleh {
            B \prec_i C
        }
        {
            \Pi x^A. B \prec_{i+1} \Pi x^A. C
        }
        $$
    \end{enumerate}
\end{definition}



\begin{lemma}
    \label{PrecedenceSubstitution}
    \emph{Substitution does not affect the predecessor relation}
    $$
    \ruleh{A \prec_i B}{A[y:=b] \prec_i B[y:=b]}
    $$

    \begin{proof}
        By induction on $A \prec_i B$.

        The first case is trivial because substitution does not modify a sort.

        The second case follows immediately from the induction hypothesis.
    \end{proof}
\end{lemma}



\begin{lemma}
    \label{PrecedenceSameArity}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%
    \emph{Subsequent predecessor relations connected by equivalent terms have
    the same aritiy}.
    $$
    \ruleh{
        A \prec_i B
        \\
        C \prec_j D
        \\
        B \betaeq C
    }
    {
        i = j
    }
    $$

    \begin{proof}
        Proof by induction on $A \prec_i B$
        \begin{enumerate}
        \item
            $$
            \begin{array}{l|l}
                -1 \le k < l
                \\
                \hline
                \Any_k \prec_0 \Any_l
                &
                \forall C D.
                \left[
                \ruleh{
                    C \prec_j D
                    \\
                    \Any_l \betaeq C
                }
                {0 = j}
                \right]
            \end{array}
            $$
            We prove the goal in the right lower corner by making a case split
            on the construction of $C \prec_j D$. Only the first case
            is possible with the trivial goal $0 = 0$. The second case is
            impossible because $\Any_l \betaeq \Pi x^A. R$ cannot be the case.

        \item
        $$
            \begin{array}{l|l}
                B \prec_i C
                &
                \forall k F G.
                \left[
                \ruleh{F \prec_k G \\ C \betaeq F}{i = k}
                \right]
                \\
                \hline
                \Pi x^A.B \prec_{i+1} \Pi x^A. C
                &
                \forall j D E.
                \left[
                \ruleh{
                    D \prec_j E
                    \\
                    \Pi x^A. C \betaeq D
                }
                {i+1 = j}
                \right]
            \end{array}
        $$
        We prove the goal in the right lower corner by making a case split on
        the construction of $D \prec_j E$.

        The first case is impossible, because $\Pi x^A. B$ cannot be beta
        equivalent to a sort.

        In the second case we construct $D \prec_j E$ as
        $\Pi x^{A'}. F \prec_{k+1} \Pi x^{A'}. G$ where $j = k + 1$,
        $D = \Pi x^{A'}. F$ and $E = \Pi x^{A'}. G$
        under the premise $F \prec_k G$.

        The condition $\Pi x^A. C \betaeq D$ becomes $\Pi x^A.C \betaeq \Pi
        x^{A'}. F$ which implies $A \betaeq A'$ and $C \betaeq F$.

        From the induction hypothesis we infer $i = k$ which implies the final
        goal $i + 1 = j$.
        \end{enumerate}
    \end{proof}
\end{lemma}



\begin{lemma}
    \label{PrecedenceTransitive}
    \emph{The predecessor relation is transitive}
    $$
    \ruleh{
        A \prec_i B
        \\
        B \prec_i C
    }
    {
        A \prec_i C
    }
    $$
    \begin{proof}
        Trivial by induction on $A \prec_i B$.
    \end{proof}
\end{lemma}






\begin{lemma}
    \label{PrecedenceEqTransitive}
    \emph{Subsequent predecessor relations connected by equivalent terms can be
    joined to one predecessor relation}.
    $$
    \ruleh{
        A \prec_i B
        \\
        B' \prec_i C'
        \\
        B \betaeq B'
    }
    {
        \exists C. C \betaeq C' \land BÂ \prec_i C
    }
    $$

    \begin{proof}
        By induction on $A \prec_i B$.
        \begin{enumerate}
        \item
            $$
            \begin{array}{l|l}
                -1 \le k < l
                \\
                \hline
                \Any_k \prec_0 \Any_l
                &
                \ruleh {
                    B' \prec_0 C'
                    \\
                    \Any_l \betaeq B'
                }
                {
                    \exists C. C \betaeq C' \land \Any_l \prec_0 C
                }
            \end{array}
            $$

            The only possibility to make both premises in the lower right corner
                valid is by
            $$
            \begin{array}{lll}
                B' &=& \Any_l
                \\
                C' &=& \Any_m
                \\
                l &<& m
            \end{array}
            $$
            The final goal is valid by setting
            $$
                C = \Any_m
            $$
            which trivially satisfies $\Any_m \betaeq \Any_m$ and $\Any_l
            \prec_0 \Any_m$


        \item
            $$
            \begin{array}{l|l}
                B \prec_i C
                &
                \forall C' D'.
                \left[
                    \ruleh {
                        C' \prec_i D'
                        \\
                        C \betaeq C'
                    }
                    {
                        \exists D. D \betaeq D' \land C \prec_i D
                    }
                \right]
                \\
                \hline
                \Pi x^A. B \prec_{i+1} \Pi x^A.C
                &
                \ruleh{
                    E' \prec_{i+1} F'
                    \\
                    \Pi x^A.C \betaeq E'
                }
                {
                    \exists F.
                    F \betaeq F'
                    \land
                    \Pi x^A. C \prec_{i+1} F
                }
            \end{array}
            $$
            From $E' \prec_{i+1} F'$ we conclude the existence of $A'$, $C'$ and
            $D'$ such that
            $$
            \begin{array}{lll}
                E' &=& \Pi x^{A'}. C'
                \\
                F' &=& \Pi x^{A'}. D'
                \\
                C' &\prec_i& D'
            \end{array}
            $$
            From $\Pi x^A.C \betaeq E'$ we infer
            $$
                A \betaeq A' \land C \betaeq C'
            $$
            Then we use the induction hypothesis to infer the existence of some
            $D$ which satisfies
            $$
                D \betaeq D' \land C \prec_i D
            $$
            Finally we use $F := \Pi x^A. D$ which satisfies the final goal.
        \end{enumerate}
    \end{proof}
\end{lemma}



\begin{lemma}
    \label{PrecedenceIrreflexive}
    \emph{The predecessor relation is irreflexive}.
    $$\ruleh {A \prec_i B \\ B \betaeq A}{\perp}$$

    \begin{proof}
        Proof by induction on $A \prec_i B$.

        \begin{enumerate}
        \item
        $$
            \begin{array}{l|l}
                -1 \le k < l
                \\
                \hline
                \Any_k \prec_0 \Any_l
                &
                \Any_l \betaeq \Any_k \imp \perp
            \end{array}
        $$
        $\Any_k$ and $\Any_l$ cannot be beta equivalent for different $k$ and $l$


        \item
        $$
            \begin{array}{l|l}
                B \prec_i C
                &
                C \betaeq B \imp \perp
                %
                \\
                \hline
                %
                \Pi x^A. B \prec_{i+1} \Pi x^A. C
                &
                \Pi x^A. C \betaeq \Pi x^A. B \imp \perp
            \end{array}
        $$
        To prove the goal in the right lower corner we assume $\Pi x^A. C
        \betaeq \Pi x^A.B$. This can be the case only if $C$ and $B$ are
        beta equivalent. From the induction hypothesis we immediately
        get the contradiction.
        \end{enumerate}
    \end{proof}
\end{lemma}








\subsection{Proper Subtype Relation}



\begin{definition}
    \emph{Proper Subtype}
    $A$ is a proper subtype of $B$ written as $A < B$
    of $A$ and $B$ if the following rule is satisfied
    $$
    \rulev{
        A \betaeq A'
        \\
        A' \prec_i B'
        \\
        B' \betaeq B
    }
    {
        A < B
    }
    $$
\end{definition}



\begin{theorem}
    \label{ProperSubtypeIrreflexive}
    \emph{The proper subtype relation is irreflexive}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    $$
    \ruleh{
        A < B
        \\
        A \betaeq B
    }
    {\perp}
    $$

    \begin{proof}
        By definition of the proper subtype relation there exists an arity $i$ and
        some type $A'$ and $B'$ with $A \betaeq A'$, $B \betaeq B'$ and $A'
        \prec_i B'$.

        We conclude $A' \betaeq B'$ from $A \betaeq B$. The
        lemma~\ref{PrecedenceIrreflexive} leads immediately to the
        contradiciton.
    \end{proof}
\end{theorem}





\begin{theorem}
    \label{ProperSubtypeTransitive}
    \emph{The proper subtype relation is transitive}
    $$
    \ruleh{
        A < B
        \\
        B < C
    }
    {A < C}
    $$

    \begin{proof}
        By definition of the proper subtype relation there exist some $A'$,
        $B'$, $B''$, $C''$, $i$ and $j$ such that the following is valid
        $$
        \begin{array}{lll}
            A' &\prec_i& B'
            \\
            A &\betaeq& A'
            \\
            B &\betaeq& B'
            \\
            B'' &\prec_j& C''
            \\
            B &\betaeq& B''
            \\
            C &\betaeq& C''
        \end{array}
        $$
        The equivalences imply $B' \betaeq B''$ which by using
        lemma~\ref{PrecedenceSameArity} implies $i = j$.

        From lemma~\ref{PrecedenceEqTransitive} we infer the existence of some
        $C'$ with
        $$
            C' \betaeq C'' \land B' \prec_i C'
        $$
        which implies with lemma~\ref{PrecedenceTransitive}
        $$
            A' \prec_i C'
        $$
        By definition of the proper subtype relation the goal
        $$
            A < C
        $$
        is evident.
    \end{proof}
\end{theorem}








\subsection{Subtype Relation}


\begin{definition}
    \emph{Subtype}
    \begin{enumerate}
    \item
        $$
        \ruleh {
            A \betaeq B
        }
        {
            A \le B
        }
        $$

    \item
        $$
        \ruleh {
            A < B
        }
        {
            A \le B
        }
        $$
    \end{enumerate}
\end{definition}



\begin{theorem}
    \label{SubtypeReduction}
    \emph{Reduction does not effect the subtype relation}
    $$
    \ruleh {
        A \le B
        \\
        t \reduce u
    }
    {
        A[x:=t] \le B[x:=u]
    }
    $$

    \begin{proof}
        MISSING !!! MISSING !!!
    \end{proof}
\end{theorem}



\begin{theorem}
    \label{SubtypeProduct1}
    \emph{If a product is a subtype of another product, then the argument type
    are beta equivalent and the result type figure in the subtype relation.}
    $$
    \ruleh {
        \Pi x^{A_1}. B_1 \le \Pi x^{A_2}. B_2
    }
    {
        A_1 \betaeq A_2 \land B_1 \le B_2
    }
    $$

    \begin{proof}
        MISSING !!! MISSING !!!
    \end{proof}
\end{theorem}



\begin{theorem}
    \label{SubtypeProduct2}
    $$
    \ruleh {
        A_1 \betaeq A_2 \land B_1 \le B_2
    }
    {
        \Pi x^{A_1}. B_1 \le \Pi x^{A_2}. B_2
    }
    $$

    \begin{proof}
        MISSING !!! MISSING !!!
    \end{proof}
\end{theorem}



\begin{theorem}
    \label{SubtypeProduct3}
    $$
    \ruleh {
        F_0 \le \Pi x^A. B
    }
    {
        \exists A_1 B_1.
        \left[
        \begin{array}{l}
            F_0 \reducestar \Pi x^{A_1}.B_1 \le \Pi x^A. B
            \\
            A_1 \betaeq A
            \\
            B_1 \le B
        \end{array}
        \right]
    }
    $$

    \begin{proof}
        MISSING !!! MISSING !!!
    \end{proof}
\end{theorem}



\begin{theorem}
    \emph{The subtype relation is reflexive with respect to beta equivalence}
    $$
    \ruleh{
        A \betaeq B
    }
    {
        A \le B
    }
    $$
    \begin{proof} Trival by the first rule.
    \end{proof}
\end{theorem}






\begin{theorem}
    \label{SubtypeTransitive}
    \emph{The subtype relation is transitive}
    $$
    \ruleh{
        A \le B
        \\
        B \le C
    }
    {
        A \le C
    }
    $$
    \begin{proof}
        We have to distinguish four cases
        \begin{enumerate}
        \item $A \betaeq B \land B \betaeq C$: Trivial by the transitivity of
            beta equivalence.

        \item $A < B \land B \betaeq C$: $A < C$ follows immediately from the
            definition of $<$.

        \item $A \betaeq B \land B < C$: $A < C$ follows immediately from the
            definition of $<$.

        \item $A < B \land B < C$: $A < C$ follows immediately from the
            transitivity of $<$~\ref{ProperSubtypeTransitive}
        \end{enumerate}
    \end{proof}
\end{theorem}


\begin{theorem}
    \emph{The subtype relation is antisymmetric with respect to beta
    equivalence}
    $$
    \ruleh{
        A \le B
        \\
        B \le A
    }
    {
        A \betaeq B
    }
    $$
    \begin{proof}
        We have to distinguish four cases:
        \begin{enumerate}
        \item $A \betaeq B \land B \betaeq A$: Trivial.

        \item $A < B \land B \betaeq A$: This case is not possible because
            the irreflexivity of the proper subtype
            relation~\ref{ProperSubtypeIrreflexive} implies a contradiction.

        \item $A \betaeq B \land B < A$: Same as the previous case.

        \item $A < B \land B < A$: By the transitivity of the proper subtype
            relation~\ref{ProperSubtypeTransitive} we infer $A < A$ which
            implies by the irreflexivity of the proper subtype
            relation~\ref{ProperSubtypeIrreflexive} immediately a
            contradiction.
        \end{enumerate}
    \end{proof}
\end{theorem}
