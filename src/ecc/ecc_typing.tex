\section{Typing}


{\scriptsize
\begin{verbatim}
    Substitution                Strengthening
    Lemma                       Lemma
      |                             |
      |                             |
      |                             v
      |                         Generation
      |                         Lemma
      |        /--------------------|
      |        |                    v
      |        |                Subject
      |        |                Reduction
      |        v
      \-->  Type of
            Types
\end{verbatim}
}





\subsection{Typing Relation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
\end{comment}

\begin{definition}
The ternary \emph{typing relation} $\Gamma \vdash t: T$ which says that in
the context $\Gamma$ then term $t$ has type $T$ is defined inductively by
the rules
\begin{enumerate}
    \item Introduction rules:
    \begin{enumerate}
        \item Axiom:
            $$
            \ruleh
            {i \in \{-1, 0, 1, 2, 3, \ldots \}}
            { [] \vdash \Any_i : \Any_{i + 1}}
            $$

        \item Variable:
            $$
            \rulev {
                \Gamma \vdash A: s
                \\
                x \notin \Gamma
            }
            {
                \Gamma, x^A \vdash x: A
            }
            $$

        \item Product:
            $$
            \rulev {
                \Gamma \vdash A: s_1
                \\
                \Gamma, x^A \vdash B: s_2
                \\
                s_1 = s_2 \lor s_2 = \Prop
            }
            {
                \Gamma \vdash \Pi x^A.B : s_2
            }
            $$

        \item Abstraction:
            $$
            \rulev {
                \Gamma \vdash \Pi x^A. B: s
                \\
                \Gamma, x^A \vdash e: B
            }
            {
                \Gamma \vdash (\lambda x^A. e): \Pi x^A. B
            }
            $$

        \item Application:
            $$
            \rulev {
                \Gamma \vdash f: \Pi x^A. B
                \\
                \Gamma \vdash a: A
            }
            {
                \Gamma \vdash f a: B[x:=a]
            }
            $$
    \end{enumerate}


    \item Structural rules:
        \begin{enumerate}
            \item Weaken:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash A: s
                    \\
                    x \notin \Gamma
                }
                {
                    \Gamma, x^A \vdash t: T
                }
                $$

            \item Subtype:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash U: s
                    \\
                    T \le U
                }
                {
                    \Gamma \vdash t: U
                }
                $$

        \end{enumerate}
    \end{enumerate}
\end{definition}



\subsection{Substitution Lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\begin{theorem}
    \label{SubstitutionLemma}
    Substitution (cut) theorem.
    $$
    \rulev{
        \Gamma \vdash a: A
        \\
        \Gamma, x^A, \Delta \vdash t: T
    }
    {
        \Gamma, \Delta[x:=a] \vdash t[x:=a]: T[x:=a]
    }
    $$

    \begin{proof}
        We assume
        $\Gamma \vdash a: A$
        and prove this theorem by induction on
        $\Gamma, x^A, \Delta \vdash t: T$.

        In order to express the proof more compactly we introduce the
        abbreviation $t' := t[x:=a]$.

        \begin{enumerate}
            \item Axiom: This case is syntactically impossible, because the
                context is not empty.

            \item Variable: We have to prove the goal
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash B: s
                    &
                    \Gamma, \Delta' \vdash B': s
                    \\
                    \hline
                    \Gamma, x^A, \Delta, y^B \vdash y: B
                    &
                    \Gamma, \Delta', y^{B'} \vdash y: B'
                \end{array}
                $$

                The final goal in the lower right corner follows directly from
                the induction hypothesis and the variable introduction rule.

            \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash B: s_1
                    &
                    \Gamma, \Delta' \vdash B': s_1
                    \\
                    \Gamma, x^A, \Delta, y^B \vdash C: s_2
                    &
                    \Gamma, \Delta', y^{B'} \vdash C': s_2
                    \\
                    s_2 = \Prop \lor s_1 = s2
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash \Pi y^B. C : s_2
                    &
                    \Gamma, \Delta' \vdash \Pi y^{B'}. C': s_2
                \end{array}
                $$

                The final goal follows from the induction hypotheses and the
                product introduction rule.

            \item Abstraction:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash \Pi y^B. C: s
                    &
                    \Gamma, \Delta' \vdash \Pi y^{B'}. C': s
                    \\
                    \Gamma, x^A, \Delta, y^B \vdash e: C
                    &
                    \Gamma, \Delta', y^{B'} \vdash e': C'
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash \lambda y^B. e: \Pi y^B. C
                    &
                    \Gamma, \Delta' \vdash \lambda y^{B'}. e' : \Pi y^{B'}. C'
                \end{array}
                $$

                Same reasoning as above.

            \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash f: \Pi y^B. C
                    &
                    \Gamma, \Delta' \vdash f' : \Pi y^{B'}. C'
                    \\
                    \Gamma, x^A, \Delta \vdash b: B
                    &
                    \Gamma, \Delta' \vdash b': B'
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash f b: C[y:=b]
                    &
                    \Gamma, \Delta' \vdash f' b': (C[y:=b])'
                \end{array}
                $$

                From the induction hypotheses and the application introduction
                rule we conclude
                $$
                    \Gamma, \Delta' \vdash f' b': C'[y:=b']
                $$
                and get the final goal by observing
                $$
                    C'[y:=b'] = (C[y:=b])'
                $$
                by using the double substition lemma~\ref{DoubleSubstitution}.

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash t: T
                    &
                    \Gamma,\Delta' \vdash t' : T'
                    \\
                    \Gamma,x^A,\Delta \vdash B: s
                    &
                    \Gamma,\Delta' \vdash B' : s'
                    \\
                    \hline
                    \Gamma,x^A,\Delta,y^B \vdash t : T
                    &
                    \Gamma,\Delta',y^{B'} \vdash t' : T'
                \end{array}
                $$
                The goal in the lower right corner can be proved by the
                    induction hypotheses and the weakening rule.

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash t : T
                    &
                    \Gamma,\Delta' \vdash t' : T'
                    \\
                    \Gamma,x^A,\Delta \vdash U : s
                    &
                    \Gamma,\Delta' \vdash U' : s'
                    \\
                    T \le U
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash t : U
                    &
                    \Gamma,\Delta' \vdash t' : U'
                \end{array}
                $$
                From the theorem~\ref{SubtypeReduction} we get $T' \le U'$. The
                    goal in the lower right corner can be proved by the
                    induction hypotheses and by applying the subtype rule.
            \end{enumerate}

        \end{enumerate}
    \end{proof}
\end{theorem}







\subsection{Strengthening Lemma}

\begin{lemma}
    \label{Strengthening}
    \emph{In all valid contexts $\Delta$ which contains at least all variables
    and their corresponding types of the valid context $\Gamma$, the same typing
    judgements are valid}.

    $$
    \rulev{
        \Gamma \vdash t : T
        \\
        \Delta \text{ valid context}
        \\
        \Gamma \subseteq \Delta
    }
    {
        \Delta \vdash t: T
    }
    $$

    \begin{proof} By induction on $\Gamma \vdash t: T$.
        {
            \newcommand{\subgoal}[4] {
                \begin{array}{l}
                    {#1} \text { valid context}
                    \\
                    {#2} \subseteq {#1}
                    \\
                    \hline
                    {#1} \vdash {#3}: {#4}
                \end{array}
            }
            \newcommand{\goal}[4] {
                \forall #1. \left( {\subgoal{#1}{#2}{#3}{#4}} \right)
            }
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort:

                We have to prove $\Delta \vdash \Any_i : \Any_{i+1}$ for $i \in
                    \set{-1, 0, 1, 2, 3, \ldots}$. Since $\Delta$ is a valid
                    context this is valid by the axioms and repeated application
                    of the weakening rule.

                \item Variable:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash x : A
                    &
                    \goal \Delta {\Gamma,x^A} x A
                \end{array}
                $$
                Since $\Gamma,x^A \subseteq \Delta$ the type judgement $x: A$
                    must be valid in $\Delta$.

                \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s_1
                    &
                    \goal \Delta \Gamma {A} {s_1}
                    \\
                    \Gamma,x^A \vdash B: s_2
                    &
                    \goal {\Delta'} {\Gamma,x^A} B {s_2}
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A.B : s_2
                    &
                    \goal \Delta \Gamma {\Pi x^A.B} {s_2}
                \end{array}
                $$
                To prove the goal in the lower right corner we assume a context
                    $\Delta$ which a valid superset of $\Gamma$. From the
                    first induction hypothesis we derive $\Gamma \vdash A: s_1$.

                Without loss of generality we assume $x \notin \Delta$,
                    otherwise we rename it (note that $x$ is not contained
                    in$A$).

                Therefore $\Delta, x^A$ is a valid context and a superset of
                    $\Gamma, x^A$. From the second induction hypothesis we get
                    $\Delta, x^A \vdash B: s_2$ which leads via the product rule
                    directly to $\Delta \vdash \Pi x^A. B: s_2$.

                \item Abstraction:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A. B: s
                    &
                    \goal \Delta \Gamma {\Pi x^A.B} s
                    \\
                    \Gamma,x^A \vdash e: B
                    &
                    \goal {\Delta'} {\Gamma, x^A} e B
                    \\
                    \hline
                    \Gamma \vdash \lambda x^A. e: \Pi x^A. B
                    &
                    \goal \Delta \Gamma {\lambda x^A. e} {\Pi x^A. B}
                \end{array}
                $$
                Same reasoning as with product.

                \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash f: \Pi x^A.B
                    &
                    \goal \Delta \Gamma f {\Pi x^A.B}
                    \\
                    \Gamma \vdash a: A
                    &
                    \goal \Delta \Gamma a A
                    \\
                    \hline
                    \Gamma \vdash f a : B[x:=a]
                    &
                    \goal \Delta \Gamma {f a} {B[x:=a]}
                \end{array}
                $$
                The goal in the lower right corner is an immediate consequence
                of the induction hypotheses.
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    &
                    \goal \Delta \Gamma t T
                    \\
                    \Gamma \vdash A : s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma,x^A \vdash t: T
                    &
                    \goal \Delta {\Gamma,x^A} t T
                \end{array}
                $$
                To prove the goal in the lower right corner we assume a valid
                    context $\Delta$ with $\Gamma,x^A \subseteq \Delta$.
                    Therfore $\Gamma \subseteq \Delta$ is valid. The final goal
                    follows from the induction hypothesis.

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t: T
                    &
                    \goal \Delta \Gamma t T
                    \\
                    \Gamma \vdash U: s
                    &
                    \goal \Delta \Gamma U s
                    \\
                    T \le U
                    \\
                    \hline
                    \Gamma \vdash t : U
                    &
                    \goal \Delta \Gamma t U
                \end{array}
                $$
                To prove the goal in the lower right corner we assume a valid
                    context $\Delta$ with $\Gamma \subseteq \Delta$. The final
                    goal is a consequence of the induction hypotheses and the
                    subtype rule.
            \end{enumerate}
        \end{enumerate}
        }
    \end{proof}
\end{lemma}






\subsection{Generation Lemmata}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

A term $t$ is welltyped if there is a context $\Gamma$ and a type $T$ such that
$\derives \Gamma t T$ is derivable. The generation lemmata postulate for each
form of the welltyped term $t$ (i.e. sort, variable, product, abstraction and
application) that there exists a type in a certain form which is a subtype of
$T$. Note that the type in the certain form is not necessarily a subtype of any
valid type of the term $t$. It is just a subtype of a certain valid type $T$ of
$t$.




\begin{theorem}
    \label{GenerationLemma}
    The following generation lemmata are valid
    \begin{enumerate}
    \item Sort:
        $$
        \ruleh {
            \Gamma \vdash \Any_i : T
        }
        {
            \Any_{i+1} \le T
        }
        $$

    \item Variable:
        $$
        \ruleh {
            \Gamma \vdash x : T
        }
        {
            \Gamma x \le T
        }
        $$
        where $\Gamma x$ is the type of $x$ in the context $\Gamma$.

    \item Product:
        $$
        \ruleh {
            \Gamma \vdash (\Pi x^A. B) : T
        }
        {
            \exists
                s_1, s_2.
                \left[
                \begin{array}{l}
                    \Gamma \vdash A: s_1
                    \\
                    \Gamma, x^A \vdash B: s_2
                    \\
                    (s_1 = s_2 \lor s_2 = \Prop)
                    \\
                    s_2 \le T
                \end{array}
                \right]
        }
        $$

    \item Abstraction:
        $$
        \ruleh {
            \Gamma \vdash (\lambda x^A. e) : T
        }
        {
            \exists
                B, s.
                \left[
                \begin{array}{l}
                    \Gamma \vdash (\Pi x^A. B): s
                    \\
                    \Gamma, x^A \vdash e: B
                    \\
                    \Pi x^A.B \le T
                \end{array}
                \right]
        }
        $$

    \item Application:
        $$
        \ruleh {
            \Gamma \vdash f a : T
        }
        {
            \exists
                A, B.
                \left[
                \begin{array}{l}
                    \Gamma \vdash f: \Pi x^A. B
                    \\
                    \Gamma \vdash a: A
                    \\
                    B[x:=a] \le T
                \end{array}
                \right]
        }
        $$
    \end{enumerate}

    \begin{proof}
        Premise in all lemmata is the validity of $\Gamma \vdash t: T$ where $t$
        is either a sort, a variable, an application, a product or an
        abstraction. The proof is done by induction on $\Gamma \vdash t: T$.

        Only one of the introduction rules is valid. For the corresponding
        introduction rule the proof of the goal is trivial.

        For all structural rules the goal follows from the induction hypothesis
        and some properties of subtyping.

        All proves follow the same pattern. We give here the proof for the
        product generation lemma.

        {\def\goal#1#2#3#4#5#6{
            \exists #1 #2.
            \left[
            \begin{array}{l}
                \derives {#3} #4 #1
                \\
                \derives {#3,x^#4} #5 #2
                \\
                #1 = #2 \lor #2 = \Prop
                \\
                #2 \le #6
            \end{array}
            \right]
         }
        \begin{enumerate}
            \item Introduction rules: Only the product rule is syntactically
                possible.
                $$
                \begin{array}{l|l}
                    \derives \Gamma A {s_1}
                    \\
                    \derives {\Gamma,x^A} B {s_2}
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \derives \Gamma {\Pi x^A. B} {s_2}
                    &
                    \goal {s_A} {s_B} \Gamma A B {s_2}
                \end{array}
                $$
                Use $s_A = s_1$ and $s_B = s_2$.

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \derives \Gamma {\Pi x^A. B} T
                    &
                    \goal {s_1} {s_2} {\Gamma} A B T
                    \\
                    \derives \Gamma C  s
                    \\
                    z \notin \Gamma
                    \\
                    \hline
                    \derives {\Gamma,z^C} {\Pi x^A. B} T
                    &
                    \goal {s_1} {s_2} {\Gamma,z^C} A B T
                \end{array}
                $$
                Use $s_1$ and $s_2$ which exist by the induction hypothesis and
                    have the properties from the induction hypothesis.

                    From that we prove the four subgoals in the lower right
                    corner.

                    The first subgoal is valid by the induction hypothesis and
                    weakening.

                    For the second subgoal we need to prove that $\Gamma,z^C,
                    x^A$ is a valid context. $\Gamma,z^C$ is certainly a valid
                    context. Without loss of generality we can assume $x \ne z$.
                    Therefore by the first subgoal we prove that
                    $\Gamma,z^C,x^A$ is a valid context. From the induction
                    hypothesis and the strengthening lemma~\ref{Strengthening}
                    we get the second subgoal.

                    The third and the forth subgoals are immediate consequences
                    of the induction hypothesis.

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A.B : T
                    &
                    \goal {s_1} {s_2} \Gamma A B T
                    \\
                    \Gamma \vdash U: s
                    \\
                    T \le U
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A.B : U
                    &
                    \goal {s_1} {s_2} \Gamma A B U
                \end{array}
                $$
                Use $s_1$ and $s_2$ from the induction hypothesis. The first
                    three subgoals in the lower right corner are identical with
                    the first three statements in the induction hypothesis. The
                    fourth subgoal follows from transitivity of
                    $\le$~\ref{SubtypeTransitive}.
            \end{enumerate}
        \end{enumerate}
        }
    \end{proof}
\end{theorem}





\subsection{Subject Reduction Lemma}

\begin{theorem}
    \label{SubjectReduction}
    \emph{Subject reduction lemma} Reduction of a term does change its type.
    $$
    \rulev{
        \Gamma \vdash t: T
        \\
        t \reduce u
    }
    {
        \Gamma \vdash u: T
    }
    $$

    {
    \def\SRLeftPart#1#2#3#4{
        \left(
        \forall #1.
        \ruleh{#2 \reduce #1}{#3 \vdash #1: #4}
        \right)
    }
    \def\SRRightPart#1#2#3#4{
        \left(
        \forall #1.
        \ruleh{#2 \reduce #1}{#1 \vdash #3: #4}
        \right)
    }

    \begin{proof} In order to prove the subject reduction lemma we prove the
        more general lemma
        $$
        \ruleh{
            \Gamma \vdash t: T
        }
        {
            \SRLeftPart u t \Gamma T
            \land
            \SRRightPart \Delta \Gamma t T
        }
        $$
        where $\Gamma \reduce \Delta$ means that $\Delta$ is $\Gamma$ with one
        of the variable types replaced by a reduced type.

        We prove the more general lemma by induction on $\Gamma \vdash t: T$.
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort: If $\Gamma$ is empty and $t$ is a sort, then the
                    goal is vacuously true because neither the empty context nor
                    a sort can reduce to anything (they are in normal form).

                \item Variable:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash A : s
                        &
                        \SRLeftPart B A \Gamma s
                        \land
                        \SRRightPart {\Delta_0} \Gamma A s
                        \\
                        \hline
                        \Gamma, x^A \vdash x: A
                        &
                        \SRLeftPart u x {\Gamma,x^A} A
                        \land
                        \SRRightPart \Delta {\Gamma,x^A} x A
                    \end{array}
                    $$
                    The left part of the goal in the lower right corner is
                    vacously true because a variable is in normal form and there
                    is no term to which it reduces.

                    For the right part we assume $\Gamma,x^A \reduce \Delta$.
                    There are two possibilities:
                    \begin{enumerate}
                        \item $\Delta = \Delta_0,x^A$ where $\Gamma \reduce
                            \Delta_0$ for some $\Delta_0$:

                        In that case we get $\Delta_0 \vdash A: s$ from the
                            induction hypothesis which implies the goal
                            $\Delta_0,x^A \vdash x: A$.

                        \item $\Delta = \Gamma,x^B$ where $A \reduce B$:

                        In that case we get $\Gamma \vdash B : s$ from the
                            induction hypothesis which implies the goal
                            $\Gamma,x^B: x \vdash B$.
                    \end{enumerate}

                \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s_1
                    &
                    \SRLeftPart C A \Gamma {s_1}
                    \lor
                    \SRRightPart \Delta \Gamma A {s_1}
                    \\
                    \Gamma,x^A \vdash B: s_2
                    &
                    \SRLeftPart D B {\Gamma,x^A} {s_2}
                    \lor
                    \SRRightPart {\Delta'} {\Gamma,x^A} B {s_2}
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A. B : s_2
                    &
                    \SRLeftPart t {\Pi x^A.B} \Gamma {s_2}
                    \land
                    \SRRightPart \Delta \Gamma {\Pi x^A. B} {s_2}
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: We assume $\Pi x^A. B \reduce t$.

                    Since products are preserved under reduction
                        (lemma~\ref{ReductionProductAbstraction}) we have either
                        $t = \Pi x^C. B$ where $A \reduce C$ for some $C$ or $t
                        = \Pi x^A.D$ where $B \reduce D$ for some $D$.

                    In both cases we can derive from the induction hypotheses
                        either $\Gamma \vdash C: s_1$ or $\Gamma,x^A \vdash D:
                        s_2$. Therefore $\Gamma \vdash \Pi x^C. B: s_2$ or $\Gamma
                        \vdash \Pi x^A.D: s_2$ is valid trivially.

                    \item Right part: Assume $\Gamma \reduce \Delta$. From the
                        first induction hypothesis we get $\Delta \vdash A:
                        s_1$. From the second induction hypothesis we get
                        $\Delta, x^A \vdash B: s_2$ where we use $\Delta' =
                        \Delta, x^A$. These facts imply $\Delta
                        \vdash \Pi x^A. B : s_2$.
                \end{enumerate}

                \item Abstraction: Same reasoning as with product.

                \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash f: \Pi x^A. B
                    &
                    \SRLeftPart g f \Gamma {\Pi x^A. B}
                    \land
                    \SRRightPart \Delta \Gamma f {\Pi x^A.B}
                    \\
                    \Gamma \vdash a: A
                    &
                    \SRLeftPart b a \Gamma A
                    \land
                    \SRRightPart \Delta \Gamma a A
                    \\
                    \hline
                    \Gamma \vdash f a: B[x:=a]
                    &
                    \SRLeftPart t {f a} \Gamma {B[x:=a]}
                    \land
                    \SRRightPart \Delta \Gamma {f a} {B[x:=a]}
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: Assume $f a \reduce t$. We have three cases
                        to consider.
                    \begin{enumerate}
                        \item $f a \reduce g a$ where $f \reduce g$:

                            From the first induction hypothesis we get that $g$
                            has the same type as $f$ and therefore $g a:
                            B[x:=a]$ is valid.

                        \item $f a \reduce f b$ where $a \reduce b$:

                            From the second induction hypothesis we get
                            $\Gamma \vdash b: A$ and therefore $\Gamma \vdash f
                            a : B[x:=b]$.

                            Since $B[x:=a]$ is a valid type and because of
                            lemma~\ref{SubstituteReduction} we have $B[x:=a]
                            \reduce B[x:=b]$ and therefore $B[x:=b] \le
                            B[x:=a]$. The subtype rule let us derive
                            $\Gamma \vdash f b: B[x:=a]$ which is identical to
                            the final goal.

                        \item $(\lambda x^A. e) a \reduce e[x:=a]$:

                            In that case we have $f = \lambda x^A. e$ i.e.
                            $\Gamma \vdash \lambda x^A. e: \Pi x^A. B$ and have
                            to prove the goal $\Gamma \vdash e[x:=a] : B[x:=a]$.

                            According to the generation lemma for
                            abstractions~\ref{GenerationLemma} there is some
                            $B_0$ and $s$ with
                            $$
                            \begin{array}{l}
                                \Gamma,x^A \vdash e: B_0
                                \\
                                \Pi x^A.  B_0 \le \Pi x^A.B
                            \end{array}
                            $$
                            which imply
                            $$
                            \begin{array}{l}
                                \Gamma \vdash e[x:=a]: B_0[x:=a]
                                \\
                                B_0 \le B
                            \end{array}
                            $$
                            by the substitution lemma~\ref{SubstitutionLemma}
                            and \ref{SubtypeProduct1}. We get the final goal by
                            applying the subtype rule.
                    \end{enumerate}

                    \item Right part: Immediate consequence of the induction
                        hypotheses.
                \end{enumerate}
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weaken:
                $$
                \begin{array}{l|l}
                \Gamma \vdash t : T
                &
                \SRLeftPart u t \Gamma T
                \land
                \SRRightPart {\Delta_0} \Gamma t T
                \\
                \Gamma \vdash A : s
                &
                \SRLeftPart B A \Gamma s
                \land
                \SRRightPart {\Delta_0} \Gamma A s
                \\
                x \notin \Gamma
                \\
                \hline
                \Gamma, x^A \vdash t : T
                &
                \SRLeftPart u t {\Gamma, x^A} T
                \land
                \SRRightPart \Delta {\Gamma,x^A} t T
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: Assume $t \reduce u$. From the first
                        induction hypothesis we get $\Gamma \vdash u : T$ which
                        derives the final goal by applying the variable
                        introduction rule.

                    \item Right part:
                        We assume $\Gamma,x^A \reduce \Delta$ and have to
                        distinguish two cases.
                        \begin{enumerate}
                        \item
                            $\Delta = (\Delta_0, x^A)
                            \land \Gamma \reduce \Delta_0$:

                            In that case we get $\Delta_0 \vdash t : T$ and
                                $\Delta_0 \vdash A : s$ from the induction
                                hypotheses which imply the final goal $\Delta_0,
                                x^A \vdash t : T$ by application of the
                                weakening rule.

                        \item
                            $\Delta = (\Gamma, x^B)
                            \land A \reduce B$:

                            In that case we get $\Gamma \vdash B : s$ from the
                                second induction hypothesis which implies the
                                final goal $\Gamma, x^B \vdash t : T$ by
                                application of the weakening rule.
                    \end{enumerate}
                \end{enumerate}


                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    &
                    \SRLeftPart u t \Gamma T
                    \land
                    \SRRightPart \Delta \Gamma t T
                    \\
                    \Gamma \vdash U : s
                    &
                    \text{not needed }
                    \land
                    \SRRightPart \Delta \Gamma U s
                    \\
                    T \le U
                    \\
                    \hline
                    \Gamma \vdash t : U
                    &
                    \SRLeftPart u t \Gamma U
                    \land
                    \SRRightPart \Delta \Gamma t U
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: Assume $t \reduce u$. We get $\Gamma \vdash
                        u: T$ by the first induction hypothesis. The final goal
                        $\Gamma \vdash u: U$ is obtained by applying the subtype
                        rule.

                    \item Right part: Assume $\Gamma \reduce \Delta$. From the
                        first induction hypothesis we derive $\Delta \vdash t :
                        T$ and from the second induction hypothesis we derive
                        $\Delta \vdash U : s$. The final goal $\Delta \vdash t:
                        U$ is obtained by applying the subtype rule.
                \end{enumerate}
            \end{enumerate}
        \end{enumerate}
    \end{proof}
    }
\end{theorem}





\subsection{Type of types}

\begin{theorem}
    \label{TypeOfTypes}
    \emph{The type of a type is a sort}
    $$
    \ruleh {
        \Gamma \vdash t: T
    }
    {
        \exists s. \Gamma \vdash T : s
    }
    $$

    \begin{proof}
        By induction of $\Gamma \vdash t : T$.
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Axiom
                $$
                \begin{array}{l|l}
                    [] \vdash \Any_i : \Any_{i+1}
                    &
                    \exists s. \Gamma \vdash \Any_{i+1}: s
                \end{array}
                $$
                Use $s = \Any_{i+2}$.

                \item Variable
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A : s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash x: A
                    &
                    \exists s_2. \Gamma,x^A \vdash A: s_2
                \end{array}
                $$
                Use $s_2 = s$ and the weakening rule.

                \item Product
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A : s_1
                    \\
                    \Gamma,x^A \vdash B: s_2
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A. B : s_2
                    &
                    \exists s_3. \Gamma \vdash s_2: s_3
                \end{array}
                $$
                For $s_2 = \Any_i$ use $s_3 = \Any_{i+1}$.

                \item Abstraction
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A. B : s_1
                    \\
                    \Gamma,x^A \vdash e: B
                    \\
                    \hline
                    \Gamma \vdash \lambda x^A. e : \Pi x^A. B
                    &
                    \exists s. \Gamma \vdash \Pi x^A. B: s
                \end{array}
                $$
                Use $s = s_1$.

                \item Application
                $$
                \begin{array}{l|l}
                    \Gamma \vdash f: \Pi x^A. B
                    &
                    \exists s_\pi: \Gamma \vdash \Pi x^A. B: s_\pi
                    \\
                    \Gamma \vdash a: A
                    \\
                    \hline
                    \Gamma \vdash f a: B[x:=a]
                    &
                    \exists s. \Gamma \vdash B[x:=a]: s
                \end{array}
                $$
                From the induction hypothesis we get a sort $s_\pi$ which is the
                type of the product. Then we use the generation
                lemma~\ref{GenerationLemma} for the product to get $s_B$ which
                satisfies $\Gamma, x^A \vdash B: s_B$. Finally we use the
                substitution lemma~\ref{SubstitutionLemma} to infer $\Gamma
                \vdash B[x:=a] : s_B$ and use $s = s_B$.
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weaken:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t: T
                    &
                    \exists s_T: \Gamma \vdash T: s_T
                    \\
                    \Gamma \vdash A: s_A
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash t: T
                    &
                    \exists s. \Gamma, x^A \vdash T: s
                \end{array}
                $$
                Use $s = s_T$ which exists by the induction hypothesis and lift
                    the typing judgement $\Gamma \vdash T : s_T$ using the
                    weakening rule into the context $\Gamma, x^A$.

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    \\
                    \Gamma \vdash U: s_U
                    \\
                    T \le U
                    \\
                    \hline
                    \Gamma \vdash t: U
                    &
                    \exists s. \Gamma \vdash U: s
                \end{array}
                $$
                Use $s = s_U$.

            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}




\subsection{Condensing Lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The \emph{condensing lemma} basically states that an unused variable in a typing
judgement can be removed from the context without affecting the validity of the
typing judgement. In order to prove this lemma we need a helper lemma.

\begin{lemma}
    \label{CondensingHelper}
    \emph{Condensing Helper Lemma}
    $$
    \rulev {
        \Gamma,x^A,\Delta \vdash t: T
        \\
        x \notin \FV \Delta \cup  \FV t
    }
    {
        \exists U. \, \Gamma, \Delta \vdash t : U \land U \le T
    }
    $$

    \begin{proof}
        {\newcommand{\goal}[4]{
            \ruleh {
                x \notin \FV (#1) \cup \FV (#2)
            }
            {
                \exists #3.
                \left[
                \begin{array}{l}
                    \Gamma,#1 \vdash #2 : #3
                    \\
                    #3 \le #4
                \end{array}
                \right]
            }
         }
        By induction on $\Gamma,x^A,\Delta \vdash t: T$.

        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort: This rule is syntactically impossible because the
                    context is not empty.

                \item Variable:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash B : s
                    &
                    \goal \Delta B {s_0} s
                    \\
                    y \notin \Gamma,x^A,\Delta
                    \\
                    \hline
                    \Gamma,x^A,\Delta,y^B \vdash y :B
                    &
                    \goal {\Delta,y^B} y U B
                \end{array}
                $$
                To prove the goal in the lower right corner we assume that $x$
                    does not occur in the free variables of $\Delta$, $y$ and
                    $B$. By the induction hypothesis we get $\Gamma,\Delta
                    \vdash B: s_0$. $s_0$ is a sort, because only sorts can be
                    subtypes of a sort.

                    Using the variable introduction rule we get
                    $\Gamma,\Delta,y^B \vdash y : B$. Using $U = B$ proves the
                    final goal.

                \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash B: s_B
                    &
                    \goal \Delta B {s_{B0}} {s_B}
                    \\
                    \Gamma,x^A,\Delta,y^B \vdash C: s_C
                    &
                    \goal {\Delta,y^B} C {s_{C0}}{s_C}
                    \\
                    s_B = s_C \lor s_C = \Prop
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash \Pi y^B.C : s_C
                    &
                    \goal \Delta {\Pi y^B.C} s {s_C}
                \end{array}
                $$
                In order to prove the goal in the lower right corner we assume
                    that $x$ does not occur free in $\Delta$ and $\Pi y^B.C$.
                    Furthermore we have $x \ne y$, otherwise the second
                    condition in the rule would not be possible.

                Therefore both induction hypotheses are applicable and we get
                    $s_{B0}$ and $s_{C0}$ satisfying the corresponding
                    properties.

                To prove the final goal we have to find a term $s$ which is a
                    subtype of $s_C$ (and therefore a sort) and satisfies
                    $\Gamma,\Delta \vdash \Pi y^B. C: s$. There are three cases
                    to distinguish.
                \begin{enumerate}
                    \item $s_C = \Prop$: In that case $s_{C0} = \Prop$ and we
                        use $s = s_{C0}$ which satisfies the goal by applying
                        the product introduction rule.

                    \item $s_B = s_C \land s_{B0} \le s_{C0}$: We use $s =
                        s_{C0}$, prove $\Gamma,\Delta \vdash B: s_{C0}$ by
                        repeated application of the weakening rule and prove the
                        final goal by applying the production introduction rule.

                    \item $s_B = s_C \land s_{B0} > s_{C0}$: We use $s =
                        s_{B0}$, prove $\Gamma,\Delta,y^B \vdash C: s_{B0}$ by
                        repeated application of the weakening rule and prove the
                        final goal by applying the production introduction rule.
                \end{enumerate}

                \item Abstraction:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash \Pi y^B.C : s
                    \\
                    \Gamma,x^A,\Delta,y^B \vdash e: C
                    &
                    \goal {\Delta,y^B} e {C_0} C
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash \lambda y^B. e: \Pi y^B.C
                    &
                    \goal \Delta {\lambda y^B. e} U {\Pi y^B.C}
                \end{array}
                $$
                In order to prove the goal in the lower right corner we assume
                that $x$ does not occur free in $\Delta$ and $\lambda x^A.e$.
                From the second induction hypothesis we get a term $C_0$ which
                satisfies $\Gamma,\Delta,y^B \vdash e: C_0$ and $C_0 \le C$.

                $B$ is a valid type in the context $\Gamma,\Delta$ and $C_0$ in
                a valid type in the context
                $\Gamma,\Delta,y^B$, therefore we can derive $\Gamma,\Delta \vdash
                \Pi y^B.C_0 : s_\pi$ for some $s_\pi$ by the product
                introduction rule.

                We use the abstraction introduction rule to derive
                $\Gamma,\Delta \vdash \lambda y^B. e: \Pi y^B. C_0$.

                Using $U =
                \Pi y^B. C_0$ satisfies the final goal because $\Pi y^B. C_0 \le
                \Pi y^B. C$ is valid (\ref{SubtypeProduct2}).

                \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash f: \Pi y^B.C
                    &
                    \goal \Delta f {F_0}{\Pi y^B.C}
                    \\
                    \Gamma,x^A,\Delta  \vdash b : B
                    &
                    \goal {\Delta} b {B_0} B
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash f b : C[y:=b]
                    &
                    \goal \Delta {f b} U {C[y:=b]}
                \end{array}
                $$

                Assume that $x$ does not occur in the free variables of $\Delta$
                and $f b$. By the first induction hypothesis we get a term $F_0$
                which has by lemma~\ref{SubtypeProduct3} the reduct $\Pi
                y^{B_1}. C_1$ such that the following is satisfied
                $$
                \begin{array}{l}
                    F_0 \reducestar \Pi y^{B_1}. C_1
                    \\
                    \Pi y^{B_1}. C_1 \le \Pi x^B. C
                    \\
                    B_1 \betaeq B
                    \\
                    C_1 \le C
                    \\
                    \Gamma,\Delta \vdash f: \Pi y^{B_1}. C_1
                \end{array}
                $$
                The last condition follows from the subject reduction
                theorem~\ref{SubjectReduction} and implies that $B_1$ is a valid
                type in the context $\Gamma,\Delta$.

                By the second induction hypothesis we get a term $B_0$ with
                $\Gamma,\Delta \vdash b : B_0$ and $B_0 \le B$ which implies
                $B_0 \le B_1$.

                Since $B_1$ is a valid type in the context $\Gamma,\Delta$ and a
                supertype of $B_0$ we get $\Gamma,\Delta \vdash b: B_1$ which
                implies by the consequences of the first induction hypothesis
                and the application introduction rule $\Gamma,\Delta \vdash f a:
                C_1[y:=b]$. I.e. we can use $U = C_1[y:=b]$ to prove the final
                goal.
            \end{enumerate}
            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash t : T
                    &
                    \goal \Delta t {T_0} T
                    \\
                    \Gamma,x^A,\Delta \vdash B : s
                    &
                    \goal \Delta B {s_0} s
                    \\
                    y \notin \Gamma,x^A,\Delta
                    \\
                    \hline
                    \Gamma,x^A,\Delta,y^B \vdash t : T
                    &
                    \goal {\Delta,y^B} t U T
                \end{array}
                $$
                We assume that $x$ does not occur free in $\Delta,y^B$ and $t$.
                    By the induction hypotheses we get some $T_0$ and $s_0$
                    which satisfy the corresponding properties. We use $U = T_0$
                    and get the final result by applying the weakening rule.

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash t : T
                    &
                    \goal \Delta t {T_0} T
                    \\
                    \Gamma,x^A,\Delta \vdash U : s
                    &
                    \goal \Delta U {s_0} s
                    \\
                    T \le U
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash t : U
                    &
                    \goal \Delta t V U
                \end{array}
                $$
                We assume that $x$ does not occur free in $\Delta$ and $t$. By
                    the induction hypotheses we get the terms $T_0$ and $s_0$
                    which satisfy the corresponding properties. Because of
                    transitivity of subtyping~\ref{SubtypeTransitive} we get $T_0
                    \le U$. We use $V = T_0$ and the subtype rule to prove the
                    final goal.

            \end{enumerate}
        \end{enumerate}
        }
    \end{proof}
\end{lemma}



\begin{lemma}
    \label{Condensing}
    \emph{An unused variable can be removed from a context without affecting its
    typing judgements}
    $$
    \rulev {
        \Gamma,x^A,\Delta \vdash t: T
        \\
        x \notin \FV \Delta \cup \FV t \cup \FV T
    }
    {
        \Gamma, \Delta \vdash t : T
    }
    $$

    \begin{proof}
        By the helper lemma~\ref{CondensingHelper} we get a term $T_0$ with
        $$
        \begin{array}{l}
            T_0 \le T
            \\
            \Gamma,\Delta \vdash t : T_0
        \end{array}
        $$

        By the type of types lemma~\ref{TypeOfTypes} we get a sort $s$ such that
        $\Gamma,x^A,\Delta \vdash T : s$ which implies by the helper lemma the
        existence of some $s_0$ with
        $$
        \Gamma,\Delta \vdash T : s_0
        $$
        Since $T$ is a supertype of $T_0$ we infer the final goal by applying
        the subtype rule.
    \end{proof}
\end{lemma}






\subsection{Minimal Types}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In many type lambda calculi we can prove that types are unique up to beta
equivalence. The presence of the subtype rule contradicts the uniquencess of
types in the extended calculus of constructions.

However there is a similar statement. We can prove that for each welltyped term
there is a \emph{minimal type} which is unique up to beta equivalence. Before
proving this we define what we mean by a \emph{minimal type}, then we prove that
the type of a variable in a valid context is its minimal type and finally we
prove that each welltyped term has a minimal type.


\begin{definition}
    \emph We say that $T$ is the \emph{minimal type} of term $t$ in the
    context $\Gamma$ which we annotate as $\derivesmin \Gamma t T$ if and only
    if
    $$
    (\derives \Gamma t T)
    \land
    \forall U. \ruleh{\derives \Gamma t U}{T \le U}
    $$
\end{definition}


\begin{lemma}
    \label{MinimalTypeOfVariable}
    \emph{The type of an introduced variable is its minimal type}.
    $$
    \ruleh{
        \derives {\Gamma,x^A} x A
    }
    {
        \derivesmin {\Gamma, x^A} x A
    }
    $$

    \begin{proof}
        Assume $\derives {\Gamma, x^A} x A$. We have to prove the goal
        $\derives {\Gamma, x^A} x A$ and
        $\forall U. \derives {\Gamma, x^A} x U \imp A \le U$.

        The first one is trivial because it is identical with the assumption.

        For the second one we assume $\derives {\Gamma, x^A} x U$ and do
        induction on it.
        \begin{enumerate}
            \item Introduction rules: The only possible introduction rule is the
                variable introduction rule. In that case we have $U = A$ and the
                goal is $A \le A$ which is trivially valid.

            \item Structural rules:
            \begin{enumerate}
                \item Weakening: In order to derive $\Gamma,x^A \vdash x: U$ by
                    the weaking rule we would need $\Gamma \vdash x : U$.
                    However this is not possible because $x \notin \Gamma$.

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \derives {\Gamma, x^A} x T
                    &
                    A \le T
                    \\
                    \derives {\Gamma, x^A} U s
                    \\
                    T \le U
                    \\
                    \hline
                    \derives {\Gamma, x^A} x U
                    &
                    A \le U
                \end{array}
                $$
                From the induction hypothesis we get $A \le U$. By transitivity
                    of the subtype relation~\ref{SubtypeTransitive} we
                    immediately get the final goal $A \le U$.
            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{lemma}



\begin{theorem}
    \label{MinimalType}
    \emph{For each welltyped term there exists a minimal type}
    $$
    \ruleh {
        \derives \Gamma t T
    }
    {
        \exists M. \derivesmin \Gamma t M
    }
    $$

    \begin{proof} By induction on $\derives \Gamma t T$
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort:
                    $$
                    \begin{array}{l|l}
                        i \in \set{-1, 0, 1, 2, \ldots}
                        \\
                        \hline
                        [] \vdash \Any_i : \Any_{i+1}
                        &
                        \exists U. [] \vdashmin \Any_i: U
                    \end{array}
                    $$
                    Obviously $U = \Any_{i+1}$ is the minimal type.

                \item Variable:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash A : s
                        \\
                        x \notin \Gamma
                        \\
                        \hline
                        \Gamma, x^A \vdash x : A
                        &
                        \exists U. \derivesmin {\Gamma, x^A} x U
                    \end{array}
                    $$
                    By lemma~\ref{MinimalTypeOfVariable} we use $U =A$ as the
                    minimal type.

                \item Product:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash A : s_1
                        &
                        \exists s_{01}. \derivesmin \Gamma A {s_{01}}
                        \\
                        \Gamma, x^A \vdash B: s_2
                        &
                        \exists s_{02}. \derivesmin {\Gamma,x^A} B {s_{02}}
                        \\
                        s_1 = s_2 \lor s_2 = \Prop
                        \\
                        \hline
                        \Gamma \vdash \Pi x^A. B : s_2
                        &
                        \exists s_\pi. \derivesmin \Gamma {\Pi x^A. B} {s_\pi}
                    \end{array}
                    $$
                    The type of a product is always a sort or a term which
                    reduces to a sort. Since reduction does not change the order
                    by definition of the order we can use the smallest sort
                    $s_\pi$ which is the type of the product.

                    We have to distinguish 3 cases:
                    \begin{enumerate}
                        \item $s_{02} = \Prop$: Since there is no smaller sort
                            than $\Prop$ we can use $s_\pi = \Prop$.

                        \item $s_{01} \le s_{02}$: Since $s_{02}$ is already the
                            smallest sort for $B$ and due to the subtype rule we
                            get $\Gamma \vdash A: s_{02}$ we can use $s_\pi =
                            s_{02}$.

                        \item $s_{01} > s_{02} \land s_{02} \ne \Prop$: In that
                            case we have to use $s_\pi = s_{01}$ and use the
                            subtype rule to derive $\Gamma, x^A \vdash B:
                            s_{01}$. No smaller sort can be the type of $\Pi
                            x^A. B$.
                    \end{enumerate}



                \item Abstraction:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash \Pi x^A. B : s
                        \\
                        \Gamma, x^A \vdash e: B
                        &
                        \exists B_0. \derivesmin {\Gamma, x^A} e {B_0}
                        \\
                        \hline
                        \Gamma \vdash \lambda x^A. e: \Pi x^A. B
                        &
                        \exists M. \derivesmin \Gamma {\lambda x^A.e} M
                    \end{array}
                    $$
                    From the induction hypothesis we get a term $B_0$ which is
                    the minimal type of $e$ in $\Gamma,x^A$. We use $M = \Pi
                    x^A. B_0$ and have to prove
                    $$
                    \forall U.
                    \ruleh
                    {\Gamma \vdash \lambda x^A. e: U}
                    {\Pi x^A.B_0 \le U}
                    $$
                    Now let's assume $\Gamma \vdash \lambda x^A.e : U$. By the
                    generation lemma for abstraction~\ref{GenerationLemma} there
                    exist some $B_1$ and $s_1$ such that
                    $$
                    \begin{array}{l}
                        \Gamma, x^A \vdash e: B_1
                        \\
                        \Pi x^A. B_1 \le U
                    \end{array}
                    $$
                    Since $B_0$ is minimal i.e. $B_0 \le B_1$ we get
                    $$
                    \Pi x^A. B_0 \le \Pi x^A. B_1 \le U
                    $$
                    Therefore we can use $M = \Pi x^A. B_1$ which satisfies the
                    final goal $M \le U$.

                \item Application:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash f: \Pi x^A.B
                        & \exists F_0.\, \derivesmin \Gamma f {F_0}
                        \\
                        \Gamma \vdash a: A
                        \\
                        \hline
                        \Gamma \vdash f a: B[x:=a]
                        &
                        \exists M.\, \derivesmin \Gamma {f a} M
                    \end{array}
                    $$

                    \begin{itemize}
                        \item
                        From the induction hypothesis we get a term $F_0$ which is
                        the minimal type of $f$ and therefore $F_0 \le \Pi x^A. B$
                        which implies by~\ref{SubtypeProduct3} the existence of
                        $A_1$ and $B_1$ with
                        $$
                        \begin{array}{l}
                            F_0 \reducestar \Pi x^{A_1}. B_1 \le \Pi x^A.B
                            \\
                            A_1 \betaeq A
                            \\
                            B_1 \le B
                        \end{array}
                        $$

                        \item We use $M = B_1[x:=a]$ and have to prove that for
                            all $U$ with $\Gamma \vdash f a: U$ we get
                            $B_1[x:=a] \le U$.

                        \item So let's assume $\Gamma \vdash f a: U$. By the
                            generation lemma~\ref{GenerationLemma} there exist some
                                $A_U$ and $B_U$ with
                            $$
                            \begin{array}{l}
                                \Gamma \vdash f: \Pi x^{A_U}. B_U
                                \\
                                \Gamma \vdash a : A_U
                                \\
                                B_U[x:=a] \le U
                            \end{array}
                            $$

                        \item Since $\Pi x^{A_1}. B_1$ is the minimal type of
                            $f$ in the context $\Gamma$ we have $\Pi x^{A_1}.
                            {B_1} \le \Pi x^{A_U}. B_U$ which implies by
                            lemma~\ref{SubtypeProduct1} $B_1 \le B_U$ and
                            therefore by lemma~\ref{SubtypeReduction} $B_1[x:=a]
                            \le B_U[x:=a]$. Therefore the final goal
                            $$
                            M = B_1[x:=a] \le B_U[x:=a] \le U
                            $$ is proven by transitivity of
                            subtype~\ref{SubtypeTransitive}
                    \end{itemize}
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t: T
                    & \exists M_0.\, \derivesmin \Gamma t T
                    \\
                    \Gamma \vdash A: s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash t : T
                    &
                    \exists M.\, \derivesmin {\Gamma, x^A} t T
                \end{array}
                $$
                    By the induction hypothesis there exists a term $M_0$ which
                    is the minimal type of $t$ in the context $\Gamma$.

                    We use $M = M_0$ and have to prove
                    \begin{itemize}
                        \item $\Gamma,x^A \vdash M_0$: This is valid by
                            weakening.

                        \item
                            $\forall U.
                            \ruleh{\Gamma,x^A \vdash t : U}{M_0 \le U}
                            $:

                            Assume $\Gamma,x^A \vdash t : U$. By the condensing
                            helper lemma~\ref{CondensingHelper} there is some
                            $U_0$ with $\Gamma \vdash t: U_0$ and $U_0 \le U$.
                            Since $M_0$ is already the minimal type of $t$ in
                            the context $\Gamma$ we get by
                            transitivity~\ref{SubtypeTransitive} $M_0 \le U$.
                    \end{itemize}

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    &
                    \exists M. \derivesmin \Gamma t M
                    \\
                    \Gamma \vdash U : s
                    \\
                    T \le U
                    \\
                    \hline
                    \Gamma \vdash t : U
                    &
                    \exists M. \derivesmin \Gamma t M
                \end{array}
                $$
                The goal in the lower right corner follows immediately from the
                    induction hypothesis.
            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}



\begin{theorem}
    \label{thm:MinimalTypeFunctionTerm}
    \emph{If $f$ is the function term of a welltyped application $fa$, then
    there is a minimal type of $f$ in the form $\Pi x^A. B$}.
    $$
    \ruleh{
        \Gamma \vdash f a : \dontcare
    }
    {
        \exists AB. \Gamma \vdashmin f : \Pi x^A. B
    }
    $$
    \begin{proof}

        MISSING!!!
    \end{proof}
\end{theorem}


\subsection{Uninhabited Types}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



There are types which cannot be inhabited by a term in normal form in the empty
context.

\begin{theorem}
    \emph{The type $\Pi X^s. X$ cannot be inhabited by a term in normal form
    (i.e. a term with no redexes) in the empty context.}
    $$
    \ruleh {
        [] \vdash t: \Pi X^s. X
        \\
        t \text{ is in normal form}
    }
    {
        \perp
    }
    $$

    \begin{proof}
        We prove this theorem by induction on the structure of $t$.
        \begin{enumerate}
        \item $t$ is the sort $s_1$:

            By the generation lemma~\ref{GenerationLemma} we postulate the
                existence of a sort $s_2$ with $[] \vdash s_1: s_2 \land s_2 \le
                \Pi X^s. X$. This is
                contradictory because $s_2 \le \Pi X^s.X$ is imposible.

        \item $t$ is a variable:
            This is impossible, because the context is empty.

        \item $t$ is a product:
            This is impossible. The type of a product is always a sort and never
                a product.

        \item $t$ is an application:

            If $t$ is an application it must have the form $h a_0 a_1 \ldots$
                where the head term $h$ is neither an application nor a sort nor
                a product. Therefore the head term must be either a variable or
                an abstraction. It cannot be a variable, because the context is
                empty. It cannot be an abstraction, because the term is in
                normal form and therefore cannot have the redex $h a_0$.

        \item $t$ is the abstraction $\lambda x^A. e$:

            By the generation lemma~\ref{GenerationLemma} we postulate the
                existence of $s_2$ and $B$ with
                $$
                \begin{array}{l}
                    [] \vdash \Pi x^A. B: s_2
                    \\
                    \text{$[x^A]$} \vdash e: B
                    \\
                    \Pi x^A. B \le \Pi X^s. X
                \end{array}
                $$

                Because of the last statement we conclude $x = X$, $A \betaeq s$
                and $B \le X$ where the latter implies $B = X$. I.e. we have
                lead the existence of $e$ with $[X^A] \vdash e: X$ to a
                contradiction.

                We prove this claim by induction on the structure of $e$.
                \begin{enumerate}
                \item $e$ is a sort:

                    This is impossible, because the type of a sort cannot be a
                        variable.

                \item $e$ is a variable: The only variable in the context is
                    $X$. By the generation lemma we know that $A \le X$. By
                        definition of $\le$ this is possible only if $A \betaeq
                        X$ which implies $X \betaeq s$ which is contradictory.
                \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}
