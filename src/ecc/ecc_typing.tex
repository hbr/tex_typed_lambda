\section{Typing}









\subsection{Typing Relation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{definition}
The ternary \emph{typing relation} $\Gamma \vdash t: T$ which says that in
the context $\Gamma$ then term $t$ has type $T$ is defined inductively by
the rules
\begin{enumerate}
    \item Introduction rules:
    \begin{enumerate}
        \item Axiom:
            $$
            \ruleh
            {i \in \{-1, 0, 1, 2, 3, \ldots \}}
            { [] \vdash \Any_i : \Any_{i + 1}}
            $$

        \item Variable:
            $$
            \rulev {
                \Gamma \vdash A: s
                \\
                x \notin \Gamma
            }
            {
                \Gamma, x^A \vdash x: A
            }
            $$

        \item Product:
            $$
            \rulev {
                \Gamma \vdash A: s_1
                \\
                \Gamma, x^A \vdash B: s_2
                \\
                s_1 = s_2 \lor s_2 = \Prop
            }
            {
                \Gamma \vdash \Pi x^A.B : s_2
            }
            $$

        \item Abstraction:
            $$
            \rulev {
                \Gamma \vdash \Pi x^A. B: s
                \\
                \Gamma, x^A \vdash e: B
            }
            {
                \Gamma \vdash (\lambda x^A. e): \Pi x^A. B
            }
            $$

        \item Application:
            $$
            \rulev {
                \Gamma \vdash f: \Pi x^A. B
                \\
                \Gamma \vdash a: A
            }
            {
                \Gamma \vdash f a: B[x:=a]
            }
            $$
    \end{enumerate}


    \item Structural rules:
        \begin{enumerate}
            \item Weaken:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash A: s
                    \\
                    x \notin \Gamma
                }
                {
                    \Gamma, x^A \vdash t: T
                }
                $$

            \item Reduction:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash U: s
                    \\
                    T \reduce U
                }
                {
                    \Gamma \vdash t: U
                }
                $$

            \item Expansion:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash U: s
                    \\
                    U \reducestar T
                }
                {
                    \Gamma \vdash t: U
                }
                $$

            \item Subtype:
                $$
                \rulev {
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash U: s
                    \\
                    T \prec_i U
                }
                {
                    \Gamma \vdash t: U
                }
                $$
        \end{enumerate}
    \end{enumerate}
\end{definition}



\subsection{Strengthening Lemma}

\begin{lemma}
    \label{Strengthening}
    \emph{In all valid contexts $\Delta$ which at least all variables and their
    corresponding types of the valid context $\Gamma$, the same typing
    judgements are valid}.

    $$
    \rulev{
        \Gamma \vdash t : T
        \\
        \Delta \text{ valid context}
        \\
        \Gamma \subseteq \Delta
    }
    {
        \Delta \vdash t: T
    }
    $$

    \begin{proof} By induction on $\Gamma \vdash t: T$.
        {
            \newcommand{\subgoal}[4] {
                \begin{array}{l}
                    {#1} \text { valid context}
                    \\
                    {#2} \subseteq {#1}
                    \\
                    \hline
                    {#1} \vdash {#3}: {#4}
                \end{array}
            }
            \newcommand{\goal}[4] {
                \forall #1. \left( {\subgoal{#1}{#2}{#3}{#4}} \right)
            }
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort:

                We have to prove $\Delta \vdash \Any_i : \Any_{i+1}$ for $i \in
                    \set{-1, 0, 1, 2, 3, \ldots}$. Since $\Delta$ is a valid
                    context this is valid by the axioms and repeated application
                    of the weakening rule.

                \item Variable:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash x : A
                    &
                    \goal \Delta {\Gamma,x^A} x A
                \end{array}
                $$
                Since $\Gamma,x^A \subseteq \Delta$ the type judgement $x: A$
                    must be valid in $\Delta$.

                \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s_1
                    &
                    \goal \Delta \Gamma {A} {s_1}
                    \\
                    \Gamma,x^A \vdash B: s_2
                    &
                    \goal {\Delta'} {\Gamma,x^A} B {s_2}
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A.B : s_2
                    &
                    \goal \Delta \Gamma {\Pi x^A.B} {s_2}
                \end{array}
                $$
                To prove the goal in the lower right corner we assume a context
                    $\Delta$ which a valid superset of $\Gamma$. From the
                    first induction hypothesis we derive $\Gamma \vdash A: s_1$.

                Without loss of generality we assume $x \notin \Delta$,
                    otherwise we rename it (note that $x$ is not contained
                    in$A$).

                Therefore $\Delta, x^A$ is a valid context and a superset of
                    $\Gamma, x^A$. From the second induction hypothesis we get
                    $\Delta, x^A \vdash B: s_2$ which leads via the product rule
                    directly to $\Delta \vdash \Pi x^A. B: s_2$.

                \item Abstraction:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A. B: s
                    &
                    \goal \Delta \Gamma {\Pi x^A.B} s
                    \\
                    \Gamma,x^A \vdash e: B
                    &
                    \goal {\Delta'} {\Gamma, x^A} e B
                    \\
                    \hline
                    \Gamma \vdash \lambda x^A. e: \Pi x^A. B
                    &
                    \goal \Delta \Gamma {\lambda x^A. e} {\Pi x^A. B}
                \end{array}
                $$
                Same reasoning as with product.

                \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash f: \Pi x^A.B
                    &
                    \goal \Delta \Gamma f {\Pi x^A.B}
                    \\
                    \Gamma \vdash a: A
                    &
                    \goal \Delta \Gamma a A
                    \\
                    \hline
                    \Gamma \vdash f a : B[x:=a]
                    &
                    \goal \Delta \Gamma {f a} {B[x:=a]}
                \end{array}
                $$
                The goal in the lower right corner is an immediate consequence
                of the induction hypotheses.
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    &
                    \goal \Delta \Gamma t T
                    \\
                    \Gamma \vdash A : s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma,x^A \vdash t: T
                    &
                    \goal \Delta {\Gamma,x^A} t T
                \end{array}
                $$
                To prove the goal in the lower right corner we assume a valid
                    context $\Delta$ with $\Gamma,x^A \subseteq \Delta$.
                    Therfore $\Gamma \subseteq \Delta$ is valid. The final goal
                    follows from the induction hypothesis.

                \item Reduction:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t: T
                    &
                    \goal \Delta \Gamma t T
                    \\
                    \Gamma \vdash U: s
                    &
                    \goal \Delta \Gamma U s
                    \\
                    T \reduce U
                    \\
                    \hline
                    \Gamma \vdash t : U
                    &
                    \goal \Delta \Gamma t U
                \end{array}
                $$
                Assume a valid context $\Delta$ with $\Gamma \subseteq \Delta$.
                    We have to prove the goal $\Delta \vdash t: U$. From the
                    induction hypotheses we get $\Delta \vdash t: T$ and $\Delta
                    \vdash U : s$ which immediately proves the goal by applying
                    the reduction rule.

                \item Expansion: Same reasoning as reduction.

                \item Subtyping: Same reasoning as reduction

            \end{enumerate}
        \end{enumerate}
        }
    \end{proof}
\end{lemma}






\subsection{Condensing Lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

REMARK: The proof for application is nontrivial!!


\begin{lemma}
    %\label{Condensing}
    \emph{An unused variable can be removed from a context without affecting its
    typing judgements}
    $$
    \rulev {
        \Gamma,x^A,\Delta \vdash t: T
        \\
        x \notin \Delta, t, T
    }
    {
        \Gamma, \Delta \vdash t : T
    }
    $$

    \begin{proof}
        {\newcommand{\goal}[3]{
            \ruleh {
                x \notin #1, #2, #3
            }
            {
                \Gamma,#1 \vdash #2 : #3
            }
         }
        By induction on $\Gamma,x^A,\Delta \vdash t: T$.

        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort: This rule is syntactically impossible because the
                    context is not empty.

                \item Variable:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash B : s
                    &
                    \goal \Delta B s
                    \\
                    y \notin \Gamma,x^A,\Delta
                    \\
                    \hline
                    \Gamma,x^A,\Delta,y^B \vdash y :B
                    &
                    \goal {\Delta,y^B} y B
                \end{array}
                $$
                To prove the goal in the lower right corner we assume that $x$
                    does not occur in the free variable of $\Delta$, $y$ and
                    $B$. The by the induction hypothesis we get $\Gamma,\Delta
                    \vdash B: s$. This implies the final goal by applying the
                    variable introduction rule.

                \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash B: s_B
                    &
                    \goal \Delta B {s_B}
                    \\
                    \Gamma,x^A,\Delta,y^B \vdash C: s_C
                    &
                    \goal {\Delta,y^B} C {s_C}
                    \\
                    s_A = s_B \lor s_B = \Prop
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash \Pi y^B.C : s_B
                    &
                    \goal \Delta {\Pi y^B.C} {s_B}
                \end{array}
                $$
                In order to prove the goal in the lower right corner we assume
                    that $x$ does not occur free in $\Delta$, $\Pi y^B.C$ and
                    $s_B$. Furthermore we have $x \ne y$, otherwise the second
                    condition in the rule would not be possible.

                Therefore both induction hypotheses are applicable and we get
                    final goal by applying the product introduction rule.

                \item Abstraction:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash \Pi y^B.C : s
                    &
                    \goal \Delta {\Pi y^B.C} s
                    \\
                    \Gamma,x^A,\Delta,y^B \vdash e: C
                    &
                    \goal {\Delta,y^B} e C
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash \lambda y^B. e: \Pi y^B.C
                    &
                    \goal \Delta {\lambda y^B. e} {\Pi y^B.C}
                \end{array}
                $$
                Same reasoning as with product.

                \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma,x^A,\Delta \vdash f: \Pi y^B.C
                    &
                    \goal \Delta f {\Pi y^B.C}
                    \\
                    \Gamma,x^A,\Delta  \vdash b : B
                    &
                    \goal {\Delta} b B
                    \\
                    \hline
                    \Gamma,x^A,\Delta \vdash f b : C[y:=b]
                    &
                    \goal \Delta {f b} {C[y:=b]}
                \end{array}
                $$

                {\bf This proof might fail here.} There seems to be no
                possibility to prove $x \notin B$ and therefore it is
                questionable, if the induction hypotheses can be used. Without
                the induction hypotheses there seems to be no way to proof the
                desired result!!!


                INCOMPLETE!! POSSIBLY IMPOSSIBLE!!!

            \end{enumerate}
            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                \end{array}
                $$

                \item Reduction:
                $$
                \begin{array}{l|l}
                \end{array}
                $$

                \item Expansion:
                $$
                \begin{array}{l|l}
                \end{array}
                $$

                \item Subtyping:
                $$
                \begin{array}{l|l}
                \end{array}
                $$

            \end{enumerate}
        \end{enumerate}
        }
    \end{proof}
\end{lemma}




\subsection{Generation Lemmata}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

A term $t$ is welltyped if there is a context $\Gamma$ and a type $T$ such that
$\derives \Gamma t T$ is derivable. The generation lemmata postulate for each
form of the welltyped term $t$ (i.e. sort, variable, product, abstraction and
application) that there exists a type in a certain form which is a subtype of
$T$. Note that the type in the certain form is not necessarily a subtype of any
valid type of the term $t$. It is just a subtype of a certain valid type $T$ of
$t$.




\begin{theorem}
    \label{GenerationLemma}
    The following generation lemmata are valid
    \begin{enumerate}
    \item Sort:
        $$
        \ruleh {
            \Gamma \vdash \Any_i : T
        }
        {
            \Any_{i+1} \le T
        }
        $$

    \item Variable:
        $$
        \ruleh {
            \Gamma \vdash x : T
        }
        {
            \Gamma x \le T
        }
        $$
        where $\Gamma x$ is the type of $x$ in the context $\Gamma$.

    \item Product:
        $$
        \ruleh {
            \Gamma \vdash (\Pi x^A. B) : T
        }
        {
            \exists
                s_1, s_2.
                \left[
                \begin{array}{l}
                    \Gamma \vdash A: s_1
                    \\
                    \Gamma, x^A \vdash B: s_2
                    \\
                    (s_1 = s_2 \lor s_2 = \Prop)
                    \\
                    s_2 \le T
                \end{array}
                \right]
        }
        $$

    \item Abstraction:
        $$
        \ruleh {
            \Gamma \vdash (\lambda x^A. e) : T
        }
        {
            \exists
                B, s.
                \left[
                \begin{array}{l}
                    \Gamma \vdash (\Pi x^A. B): s
                    \\
                    \Gamma, x^A \vdash e: B
                    \\
                    \Pi x^A.B \le T
                \end{array}
                \right]
        }
        $$

    \item Application:
        $$
        \ruleh {
            \Gamma \vdash f a : T
        }
        {
            \exists
                A, B.
                \left[
                \begin{array}{l}
                    \Gamma \vdash f: \Pi x^A. B
                    \\
                    \Gamma \vdash a: A
                    \\
                    B[x:=a] \le T
                \end{array}
                \right]
        }
        $$
    \end{enumerate}

    \begin{proof}
        Premise in all lemmata is the validity of $\Gamma \vdash t: T$ where $t$
        is either a sort, a variable, an application, a product or an
        abstraction. The proof is done by induction on $\Gamma \vdash t: T$.

        Only one of the introduction rules is valid. For the corresponding
        introduction rule the proof of the goal is trivial.

        For all structural rules the goal follows from the induction hypothesis
        and some properties of subtyping.

        All proves follow the same pattern. We give here the proof for the
        product generation lemma.

        {\def\goal#1#2#3#4#5#6{
            \exists #1 #2.
            \left[
            \begin{array}{l}
                \derives {#3} #4 #1
                \\
                \derives {#3,x^#4} #5 #2
                \\
                #1 = #2 \lor #2 = \Prop
                \\
                #2 \le #6
            \end{array}
            \right]
         }
        \begin{enumerate}
            \item Introduction rules: Only the product rule is syntactically
                possible.
                $$
                \begin{array}{l|l}
                    \derives \Gamma A {s_1}
                    \\
                    \derives {\Gamma,x^A} B {s_2}
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \derives \Gamma {\Pi x^A. B} {s_2}
                    &
                    \goal {s_A} {s_B} \Gamma A B {s_2}
                \end{array}
                $$
                Use $s_A = s_1$ and $s_B = s_2$.

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \derives \Gamma {\Pi x^A. B} T
                    &
                    \goal {s_1} {s_2} {\Gamma} A B T
                    \\
                    \derives \Gamma C  s
                    \\
                    z \notin \Gamma
                    \\
                    \hline
                    \derives {\Gamma,z^C} {\Pi x^A. B} T
                    &
                    \goal {s_1} {s_2} {\Gamma,z^C} A B T
                \end{array}
                $$
                Use $s_1$ and $s_2$ which exist by the induction hypothesis and
                    have the properties from the induction hypothesis.

                    From that we prove the four subgoals in the lower right
                    corner.

                    The first subgoal is valid by the induction hypothesis and
                    weakening.

                    For the second subgoal we need to prove that $\Gamma,z^C,
                    x^A$ is a valid context. $\Gamma,z^C$ is certainly a valid
                    context. Without loss of generality we can assume $x \ne z$.
                    Therefore by the first subgoal we prove that
                    $\Gamma,z^C,x^A$ is a valid context. From the induction
                    hypothesis and the strengthening lemma~\ref{Strengthening}
                    we get the second subgoal.

                    The third and the forth subgoals are immediate consequences
                    of the induction hypothesis.

                \item Reduction:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A.B : T
                    &
                    \goal {s_1} {s_2} \Gamma A B T
                    \\
                    \Gamma \vdash U: s
                    \\
                    T \reduce U
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A.B : U
                    &
                    \goal {s_1} {s_2} \Gamma A B U
                \end{array}
                $$
                Use $s_1$ and $s_2$ from the induction hypothesis. The first
                    three subgoals in the lower right corner are identical with
                    the first three statements in the induction hypothesis. The
                    fourth subgoal follows from the induction hypothesis and $T
                    \reduce U$ and basic properties of $\le$.

                \item Expansion: Same reasoning as reduction.

                \item Subtype: Same reasoning as reduction.

            \end{enumerate}
        \end{enumerate}
        }
    \end{proof}
\end{theorem}





\subsection{Substitution Lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\begin{theorem}
    \label{SubstitutionLemma}
    Substitution (cut) theorem.
    $$
    \rulev{
        \Gamma \vdash a: A
        \\
        \Gamma, x^A, \Delta \vdash t: T
    }
    {
        \Gamma, \Delta[x:=a] \vdash t[x:=a]: T[x:=a]
    }
    $$

    \begin{proof}
        We assume
        $\Gamma \vdash a: A$
        and prove this theorem by induction on
        $\Gamma, x^A, \Delta \vdash t: T$.

        In order to express the proof more compactly we introduce the
        abbreviation $t' := t[x:=a]$.

        \begin{enumerate}
            \item Axiom: This case is syntactically impossible, because the
                context is not empty.

            \item Variable: We have to prove the goal
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash B: s
                    &
                    \Gamma, \Delta' \vdash B': s
                    \\
                    \hline
                    \Gamma, x^A, \Delta, y^B \vdash y: B
                    &
                    \Gamma, \Delta', y^{B'} \vdash y: B'
                \end{array}
                $$

                The final goal in the lower right corner follows directly from
                the induction hypothesis and the variable introduction rule.

            \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash B: s_1
                    &
                    \Gamma, \Delta' \vdash B': s_1
                    \\
                    \Gamma, x^A, \Delta, y^B \vdash C: s_2
                    &
                    \Gamma, \Delta', y^{B'} \vdash C': s_2
                    \\
                    s_2 = \Prop \lor s_1 = s2
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash \Pi y^B. C : s_2
                    &
                    \Gamma, \Delta' \vdash \Pi y^{B'}. C': s_2
                \end{array}
                $$

                The final goal follows from the induction hypotheses and the
                product introduction rule.

            \item Abstraction:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash \Pi y^B. C: s
                    &
                    \Gamma, \Delta' \vdash \Pi y^{B'}. C': s
                    \\
                    \Gamma, x^A, \Delta, y^B \vdash e: C
                    &
                    \Gamma, \Delta', y^{B'} \vdash e': C'
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash \lambda y^B. e: \Pi y^B. C
                    &
                    \Gamma, \Delta' \vdash \lambda y^{B'}. e' : \Pi y^{B'}. C'
                \end{array}
                $$

                Same reasoning as above.

            \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma, x^A, \Delta \vdash f: \Pi y^B. C
                    &
                    \Gamma, \Delta' \vdash f' : \Pi y^{B'}. C'
                    \\
                    \Gamma, x^A, \Delta \vdash b: B
                    &
                    \Gamma, \Delta' \vdash b': B'
                    \\
                    \hline
                    \Gamma, x^A, \Delta \vdash f b: C[y:=b]
                    &
                    \Gamma, \Delta' \vdash f' b': C[y:=b]'
                \end{array}
                $$

                From the induction hypotheses and the application introduction
                rule we conclude
                $$
                    \Gamma, \Delta' \vdash f' b': C'[y:=b']
                $$
                and get the final goal by observing
                $$
                    C'[y:=b'] = C[y:=b]'
                $$
                by using the double substition lemma~\ref{DoubleSubstitution}.

            \item Structural rules: For all structural rules we prove the final
                goal by the induction hypothesis and by the facts
                $$
                \begin{array}{llll}
                    t \reduce u     &\imp& t' \reduce u'
                    &\text{Lemma~\ref{SubstituteReduction}}
                    \\
                    A \prec_i B     &\imp& A' \prec_i B'
                    &\text{Lemma~\ref{PrecedenceSubstitution}}
                \end{array}
                $$

        \end{enumerate}
    \end{proof}
\end{theorem}






\subsection{Type of types}

\begin{theorem}
    \label{TypeOfTypes}
    \emph{The type of a type is a sort}
    $$
    \ruleh {
        \Gamma \vdash t: T
    }
    {
        \exists s. \Gamma \vdash T : s
    }
    $$

    \begin{proof}
        By induction of $\Gamma \vdash t : T$.
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Axiom
                $$
                \begin{array}{l|l}
                    [] \vdash \Any_i : \Any_{i+1}
                    &
                    \exists s. \Gamma \vdash \Any_{i+1}: s
                \end{array}
                $$
                Use $s = \Any_{i+2}$.

                \item Variable
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A : s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash x: A
                    &
                    \exists s_2. \Gamma,x^A \vdash A: s_2
                \end{array}
                $$
                Use $s_2 = s$ and the weakening rule.

                \item Product
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A : s_1
                    \\
                    \Gamma,x^A \vdash B: s_2
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A. B : s_2
                    &
                    \exists s_3. \Gamma \vdash s_2: s_3
                \end{array}
                $$
                For $s_2 = \Any_i$ use $s_3 = \Any_{i+1}$.

                \item Abstraction
                $$
                \begin{array}{l|l}
                    \Gamma \vdash \Pi x^A. B : s_1
                    \\
                    \Gamma,x^A \vdash e: B
                    \\
                    \hline
                    \Gamma \vdash \lambda x^A. e : \Pi x^A. B
                    &
                    \exists s. \Gamma \vdash \Pi x^A. B: s
                \end{array}
                $$
                Use $s = s_1$.

                \item Application
                $$
                \begin{array}{l|l}
                    \Gamma \vdash f: \Pi x^A. B
                    &
                    \exists s_\pi: \Gamma \vdash \Pi x^A. B: s_\pi
                    \\
                    \Gamma \vdash a: A
                    \\
                    \hline
                    \Gamma \vdash f a: B[x:=a]
                    &
                    \exists s. \Gamma \vdash B[x:=a]: s
                \end{array}
                $$
                From the induction hypothesis we get a sort $s_\pi$ which is the
                type of the product. Then we use the generation
                lemma~\ref{GenerationLemma} for the product to get $s_B$ which
                satisfies $\Gamma, x^A \vdash B: s_B$. Finally we use the
                substitution lemma~\ref{SubstitutionLemma} to infer $\Gamma
                \vdash B[x:=a] : s_B$ and use $s = s_B$.
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weaken:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t: T
                    &
                    \exists s_T: \Gamma \vdash T: s_T
                    \\
                    \Gamma \vdash A: s_A
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash t: T
                    &
                    \exists s. \Gamma, x^A \vdash T: s
                \end{array}
                $$
                Use $s = s_T$ which exists by the induction hypothesis and lift
                    the typing judgement $\Gamma \vdash T : s_T$ using the
                    weakening rule into the context $\Gamma, x^A$.

                \item Reduction:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    \\
                    \Gamma \vdash U: s_U
                    \\
                    T \reduce U
                    \\
                    \hline
                    \Gamma \vdash t: U
                    &
                    \exists s. \Gamma \vdash U: s
                \end{array}
                $$
                Use $s = s_U$.

                \item Expansion:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    \\
                    \Gamma \vdash U: s_U
                    \\
                    U \reducestar T
                    \\
                    \hline
                    \Gamma \vdash t: U
                    &
                    \exists s. \Gamma \vdash U: s
                \end{array}
                $$
                Use $s = s_U$.

                \item Subtype:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    \\
                    \Gamma \vdash U: s_U
                    \\
                    T \prec_i U
                    \\
                    \hline
                    \Gamma \vdash t: U
                    &
                    \exists s. \Gamma \vdash U: s
                \end{array}
                $$
                Use $s = s_U$.
            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}




\subsection{Minimal Types}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{definition}
    \emph We say that $T$ is the \emph{minimal type} of term $t$ in the
    context $\Gamma$ which we annotate as $\derivesmin \Gamma t T$ if and only
    if
    $$
    (\derives \Gamma t T)
    \land
    \forall U. \ruleh{\derives \Gamma t U}{T \le U}
    $$
\end{definition}


\begin{lemma}
    \label{MinimalTypeOfVariable}
    \emph{The type of an introduced variable is its minimal type}.
    $$
    \ruleh{
        \derives {\Gamma,x^A} x A
    }
    {
        \derivesmin {\Gamma, x^A} x A
    }
    $$

    \begin{proof}
        Assume $\derives {\Gamma, x^A} x A$. We have to prove the goal
        $\derives {\Gamma, x^A} x A$ and
        $\forall U. \derives {\Gamma, x^A} x U \imp A \le U$.

        The first one is trivial because it is identical with the assumption.

        For the second one we assume $\derives {\Gamma, x^A} x U$ and do
        induction on it.
        \begin{enumerate}
            \item Introduction rules: The only possible introduction rule is the
                variable introduction rule. In that case we have $U = A$ and the
                goal is $A \le A$ which is trivially valid.

            \item Structural rules:
            \begin{enumerate}
                \item Weakening: This rule is not possible because $x \notin
                    \Gamma$ and therefore $\derives \Gamma x U$ is not possible.

                \item Reduction:
                $$
                \begin{array}{l|l}
                    \derives {\Gamma, x^A} x U
                    &
                    A \le U
                    \\
                    \derives {\Gamma, x^A} V s
                    \\
                    U \reduce V
                    \\
                    \hline
                    \derives {\Gamma, x^A} x V
                    &
                    A \le V
                \end{array}
                $$
                From the induction hypothesis we get $A \le U$. Since $U \reduce
                    V$ we immidiately get the goal $A \le V$.

                \item Expansion: Same reasoning as reduction.

                \item Subtyping: Same reasoning as reduction.
            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{lemma}



\begin{theorem}
    \label{MinimalType}
    \emph{For each welltyped term there exists a minimal type}
    $$
    \ruleh {
        \derives \Gamma t T
    }
    {
        \exists M. \derivesmin \Gamma t M
    }
    $$

    \begin{proof} By induction on $\derives \Gamma t T$
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort:
                    $$
                    \begin{array}{l|l}
                        i \in \set{-1, 0, 1, 2, \ldots}
                        \\
                        \hline
                        [] \vdash \Any_i : \Any_{i+1}
                        &
                        \exists U. [] \vdashmin \Any_i: U
                    \end{array}
                    $$
                    Obviously $U = \Any_{i+1}$ is the minimal type.

                \item Variable:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash A : s
                        \\
                        x \notin \Gamma
                        \\
                        \hline
                        \Gamma, x^A \vdash x : A
                        &
                        \exists U. \derivesmin {\Gamma, x^A} x U
                    \end{array}
                    $$
                    By lemma~\ref{MinimalTypeOfVariable} we use $U =A$ as the
                    minimal type.

                \item Product:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash A : s_1
                        &
                        \exists s_{01}. \derivesmin \Gamma A {s_{01}}
                        \\
                        \Gamma, x^A \vdash B: s_2
                        &
                        \exists s_{02}. \derivesmin {\Gamma,x^A} B {s_{02}}
                        \\
                        s_1 = s_2 \lor s_2 = \Prop
                        \\
                        \hline
                        \Gamma \vdash \Pi x^A. B : s_2
                        &
                        \exists s_\pi. \derivesmin \Gamma {\Pi x^A. B} {s_\pi}
                    \end{array}
                    $$
                    The type of a product is always a sort or a term which
                    reduces to a sort. Since reduction does not change the order
                    by definition of the order we can use the smallest sort
                    $s_\pi$ which is the type of the product.

                    We have to distinguish 3 cases:
                    \begin{enumerate}
                        \item $s_{02} = \Prop$: Since there is no smaller sort
                            than $\Prop$ we can use $s_\pi = \Prop$.

                        \item $s_{01} \le s_{02}$: Since $s_{02}$ is already the
                            smallest sort for $B$ and due to the subtype rule we
                            get $\Gamma \vdash A: s_{02}$ we can use $s_\pi =
                            s_{02}$.

                        \item $s_{01} > s_{02} \land s_{02} \ne \Prop$: In that
                            case we have to use $s_\pi = s_{01}$ and use the
                            subtype rule to derive $\Gamma, x^A \vdash B:
                            s_{01}$. No smaller sort can be the type of $\Pi
                            x^A. B$.
                    \end{enumerate}



                \item Abstraction:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash \Pi x^A. B : s
                        \\
                        \Gamma, x^A \vdash e: B
                        &
                        \exists B_0. \derivesmin {\Gamma, x^A} e {B_0}
                        \\
                        \hline
                        \Gamma \vdash \lambda x^A. e: \Pi x^A. B
                        &
                        \exists M. \derivesmin \Gamma {\lambda x^A.e} M
                    \end{array}
                    $$
                    From the induction hypothesis we get a term $B_0$ which is
                    the minimal type of $e$ in $\Gamma,x^A$. We use $M = \Pi
                    x^A. B_0$ and have to prove
                    $$
                    \forall U.
                    \ruleh
                    {\Gamma \vdash \lambda x^A. e: U}
                    {\Pi x^A.B_0 \le U}
                    $$
                    Now let's assume $\Gamma \vdash \lambda x^A.e : U$. By the
                    generation lemma for abstraction~\ref{GenerationLemma} there
                    exist some $B_1$ and $s_1$ such that
                    $$
                    \begin{array}{l}
                        \Gamma, x^A \vdash e: B_1
                        \\
                        \Pi x^A. B_1 \le U
                    \end{array}
                    $$
                    Since $B_0$ is minimal i.e. $B_0 \le B_1$ we get
                    $$
                    \Pi x^A. B_0 \le \Pi x^A. B_1 \le U
                    $$
                    an therefore $\Pi x^A. B_0$ is really minimal.

                \item Application:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash f: \Pi x^A.B
                        \\
                        \Gamma \vdash a: A
                        \\
                        \hline
                        \Gamma \vdash f a: B[x:=a]
                        &
                        \exists M. \derivesmin \Gamma {f a} M
                    \end{array}
                    $$

                    INCOMPLETE !!!

            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weakening:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t: T
                    \\
                    \Gamma \vdash A: s
                    \\
                    x \notin \Gamma
                    \\
                    \hline
                    \Gamma, x^A \vdash t : T
                    &
                    \exists M. \derivesmin {\Gamma, x^A} t T
                \end{array}
                $$
                    INCOMPLETE!!!

                \item Reduction:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash t : T
                    &
                    \exists M. \derivesmin \Gamma t M
                    \\
                    \Gamma \vdash U : s
                    \\
                    T \reduce U
                    \\
                    \hline
                    \Gamma \vdash t : U
                    &
                    \exists M. \derivesmin \Gamma t M
                \end{array}
                $$
                The goal in the lower right corner follows immediately from the
                    induction hypothesis.

                \item Expansion: Same reasoning as with reduction.

                \item Subtyping: Same reasoning as with reduction.

            \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}



\subsection{Subject Reduction Lemma}

\begin{theorem}
    \label{SubjectReduction}
    \emph{Subject reduction lemma} Reduction of a term does change its type.
    $$
    \rulev{
        \Gamma \vdash t: T
        \\
        t \reduce u
    }
    {
        \Gamma \vdash u: T
    }
    $$

    {
    \def\SRLeftPart#1#2#3#4{
        \left(
        \forall #1.
        \ruleh{#2 \reduce #1}{#3 \vdash #1: #4}
        \right)
    }
    \def\SRRightPart#1#2#3#4{
        \left(
        \forall #1.
        \ruleh{#2 \reduce #1}{#1 \vdash #3: #4}
        \right)
    }

    \begin{proof} In order to prove the subject reduction lemma we prove the
        more general lemma
        $$
        \ruleh{
            \Gamma \vdash t: T
        }
        {
            \SRLeftPart u t \Gamma T
            \land
            \SRRightPart \Delta \Gamma t T
        }
        $$
        where $\Gamma \reduce \Delta$ means that $\Delta$ is $\Gamma$ with one
        of the variable types replaced by a reduced type.

        We prove the more general lemma by induction on $\Gamma \vdash t: T$.
        \begin{enumerate}
            \item Introduction rules:
            \begin{enumerate}
                \item Sort: If $\Gamma$ is empty and $t$ is a sort, then the
                    goal is vacuously true because neither the empty context nor
                    a sort can reduce to anything (they are in normal form).

                \item Variable:
                    $$
                    \begin{array}{l|l}
                        \Gamma \vdash A : s
                        &
                        \SRLeftPart B A \Gamma s
                        \land
                        \SRRightPart {\Delta_0} \Gamma A s
                        \\
                        \hline
                        \Gamma, x^A \vdash x: A
                        &
                        \SRLeftPart u x {\Gamma,x^A} A
                        \land
                        \SRRightPart \Delta {\Gamma,x^A} x A
                    \end{array}
                    $$
                    The left part of the goal in the lower right corner is
                    vacously true because a variable is in normal form and there
                    is no term to which it reduces.

                    For the right part we assume $\Gamma,x^A \reduce \Delta$.
                    There are two possibilities:
                    \begin{enumerate}
                        \item $\Delta = \Delta_0,x^A$ where $\Gamma \reduce
                            \Delta_0$ for some $\Delta_0$:

                        In that case we get $\Delta_0 \vdash A: s$ from the
                            induction hypothesis which implies the goal
                            $\Delta_0,x^A \vdash x: A$.

                        \item $\Delta = \Gamma,x^B$ where $A \reduce B$:

                        In that case we get $\Gamma \vdash B : s$ from the
                            induction hypothesis which implies the goal
                            $\Gamma,x^B: x \vdash B$.
                    \end{enumerate}

                \item Product:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash A: s_1
                    &
                    \SRLeftPart C A \Gamma {s_1}
                    \lor
                    \SRRightPart \Delta \Gamma A {s_1}
                    \\
                    \Gamma,x^A \vdash B: s_2
                    &
                    \SRLeftPart D B {\Gamma,x^A} {s_2}
                    \lor
                    \SRRightPart {\Delta'} {\Gamma,x^A} B {s_2}
                    \\
                    s_1 = s_2 \lor s_2 = \Prop
                    \\
                    \hline
                    \Gamma \vdash \Pi x^A. B : s_2
                    &
                    \SRLeftPart t {\Pi x^A.B} \Gamma {s_2}
                    \land
                    \SRRightPart \Delta \Gamma {\Pi x^A. B} {s_2}
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: We assume $\Pi x^A. B \reduce t$.

                    Since products are preserved under reduction
                        (lemma~\ref{ReductionProductAbstraction}) we have either
                        $t = \Pi x^C. B$ where $A \reduce C$ for some $C$ or $t
                        = \Pi x^A.D$ where $B \reduce D$ for some $D$.

                    In both cases we can derive from the induction hypotheses
                        either $\Gamma \vdash C: s_1$ or $\Gamma,x^A \vdash D:
                        s_2$. Therefore $\Gamma \vdash \Pi x^C. B: s_2$ or $\Gamma
                        \vdash \Pi x^A.D: s_2$ is valid trivially.

                    \item Right part: Assume $\Gamma \reduce \Delta$. From the
                        first induction hypothesis we get $\Delta \vdash A:
                        s_1$. From the second induction hypothesis we get
                        $\Delta, x^A \vdash B: s_2$ where we use $\Delta' =
                        \Delta, x^A$. These facts imply $\Delta
                        \vdash \Pi x^A. B : s_2$.
                \end{enumerate}

                \item Abstraction: Same reasoning as with product.

                \item Application:
                $$
                \begin{array}{l|l}
                    \Gamma \vdash f: \Pi x^A. B
                    &
                    \SRLeftPart g f \Gamma {\Pi x^A. B}
                    \land
                    \SRRightPart \Delta \Gamma f {\Pi x^A.B}
                    \\
                    \Gamma \vdash a: A
                    &
                    \SRLeftPart b a \Gamma A
                    \land
                    \SRRightPart \Delta \Gamma a A
                    \\
                    \hline
                    \Gamma \vdash f a: B[x:=a]
                    &
                    \SRLeftPart t {f a} \Gamma {B[x:=a]}
                    \land
                    \SRRightPart \Delta \Gamma {f a} {B[x:=a]}
                \end{array}
                $$
                \begin{enumerate}
                    \item Left part: Assume $f a \reduce t$. We have three cases
                        to consider.
                    \begin{enumerate}
                        \item $f a \reduce g a$ where $f \reduce g$: From the
                            first induction hypothesis we get that $g$ has the
                            same type as $f$ and therefore $g a: B[x:=a]$ is
                            valid.

                        \item $f a \reduce f b$ where $a \reduce b$:
                            From the second induction hypothesis we get that $b$
                            has the same type as $a$ and therefore $f b:
                            B[x:=b]$ is valid. ?????INCOMPLETE???

                        \item $(\lambda y^B. e) a \reduce e[y:=a]$:

                    \end{enumerate}

                    \item Right part: Immediate consequence of the induction
                        hypotheses.
                \end{enumerate}
            \end{enumerate}

            \item Structural rules:
            \begin{enumerate}
                \item Weaken:
            \end{enumerate}
        \end{enumerate}

        INCOMPLETE!!!
    \end{proof}
    }
\end{theorem}





\subsection{Uninhabited Types}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



There are types which cannot be inhabited by a term in normal form in the empty
context.

\begin{theorem}
    \emph{The type $\Pi X^s. X$ cannot be inhabited by a term in normal form
    (i.e. a term with no redexes) in the empty context.}
    $$
    \ruleh {
        [] \vdash t: \Pi X^s. X
        \\
        t \text{ is in normal form}
    }
    {
        \perp
    }
    $$

    \begin{proof}
        We prove this theorem by induction on the structure of $t$.
        \begin{enumerate}
        \item $t$ is the sort $s_1$:

            By the generation lemma we postulate the existence of a sort $s_2$
                with $[] \vdash s_1: s_2 \land s_2 \le \Pi X^s. X$. This is
                contradictory because $s_2 \le \Pi X^s.X$ is imposible.

        \item $t$ is a variable:
            This is impossible, because the context is empty.

        \item $t$ is a product:
            This is impossible. The type of a product is always a sort and never
                a product.

        \item $t$ is an application:

            If $t$ is an application it must have the form $h a_0 a_1 \ldots$
                where the head term $h$ is neither an application nor a sort nor
                a product. Therefore the head term must be either a variable or
                an abstraction. It cannot be a variable, because the context is
                empty. It cannot be an abstraction, because the term is in
                normal form and therefore cannot have the redex $h a_0$.

        \item $t$ is the abstraction $\lambda x^A. e$:

            By the generation lemma we postulate the existence of $s_2$ and $B$
                with
                $$
                \begin{array}{l}
                    [] \vdash \Pi x^A. B: s_2
                    \\
                    \text{$[x^A]$} \vdash e: B
                    \\
                    \Pi x^A. B \le \Pi X^s. X
                \end{array}
                $$

                Because of the last statement we conclude $x = X$, $A \equiv s$
                and $B \le X$ where the latter implies $B = X$. I.e. we have
                lead the existence of $e$ with $[X^A] \vdash e: X$ to a
                contradiction.

                We prove this claim by induction on the structure of $e$.
                \begin{enumerate}
                \item $e$ is a sort:

                    This is impossible, because the type of a sort cannot be a
                        variable.

                \item $e$ is a variable: The only variable in the context is
                    $X$. By the generation lemma we know that $A \le X$. By
                        definition of $\le$ this is possible only if $A \equiv
                        X$ which implies $X \equiv s$ which is contradictory.
                \end{enumerate}
        \end{enumerate}
    \end{proof}
\end{theorem}
